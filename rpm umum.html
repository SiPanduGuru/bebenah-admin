<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SiPandu RPM - Midnight Command Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* THE DARK ACADEMIA VIBE - RADIAL GRADIENT DNA */
        :root {
            --bg-main: #0f0b1e;          /* Background semesta */
            --bg-panel: #15102b;        /* Sidebar depth */
            --bg-card: #1c153a;         /* Card depth */
            
            --purple-main: #6d28d9;     /* Ungu berwibawa */
            --purple-soft: #8b5cf6;     /* Light neon touch */
            --purple-glow: rgba(139, 92, 246, 0.25);
            
            --text-main: #f5f3ff;
            --text-muted: #b6b0d8;
            --accent-green: #22c55e;
            --accent-orange: #e67e22;
        }

        body { 
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; 
            background: var(--bg-main); 
            margin: 0; 
            padding: 0; 
            color: var(--text-main); 
            line-height: 1.6; 
        }

        /* SIDEBAR - MIDNIGHT PANEL */
        .wrapper { display: flex; min-height: 100vh; }
        .sidebar { 
            width: 320px; 
            background: linear-gradient(180deg, #120d2a 0%, #0f0b1e 100%);
            color: white; 
            padding: 30px; 
            box-shadow: inset -1px 0 0 rgba(255,255,255,0.05);
            position: sticky; 
            top: 0; 
            height: 100vh; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
        }

        .brand-box { margin-bottom: 30px; border-bottom: 1px solid rgba(139, 92, 246, 0.1); padding-bottom: 25px; }
        .brand-title { 
            font-size: 24px; 
            font-weight: 900; 
            color: var(--purple-soft); 
            margin: 0; 
            letter-spacing: 3px;
            text-shadow: 0 0 15px var(--purple-glow);
        }
        
        .reflective-note { 
            font-size: 12px; 
            color: var(--text-muted); 
            font-style: italic; 
            margin-top: 15px; 
            border-left: 2px solid var(--purple-main); 
            padding-left: 15px; 
            line-height: 1.6; 
        }

        /* MAIN AREA */
        .main-content { flex: 1; padding: 40px; background: radial-gradient(circle at top right, #1a1440, #0f0b1e); }
        
        .container { 
            max-width: 1000px; 
            margin: auto; 
            background: radial-gradient(circle at top left, #221a4d, #15102b);
            padding: 50px; 
            border-radius: 30px; 
            box-shadow: 0 40px 100px rgba(0,0,0,0.6), inset 0 0 0 1px rgba(255,255,255,0.05);
            animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* FORM HEADER */
        .header { text-align: center; margin-bottom: 50px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 30px; }
        .header h1 { font-size: 32px; font-weight: 900; letter-spacing: -1px; margin: 0; color: #fff; }
        .header p { color: var(--text-muted); font-size: 14px; margin-top: 10px; text-transform: uppercase; letter-spacing: 2px; }

        /* SECTION TITLES */
        h2 { 
            background: linear-gradient(90deg, var(--purple-main), transparent);
            color: #fff; 
            padding: 15px 25px; 
            font-size: 13px; 
            border-radius: 12px; 
            margin-top: 50px; 
            text-transform: uppercase; 
            letter-spacing: 2px;
            font-weight: 800;
            border-left: 4px solid var(--purple-soft);
        }

        /* INPUTS - PROFESSIONAL DARK MODE */
        .grid-id { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 25px; 
            background: rgba(15, 11, 30, 0.4);
            padding: 30px; 
            border-radius: 20px; 
            border: 1px solid rgba(255,255,255,0.03);
        }
        
        label { display: block; font-weight: 700; margin-bottom: 10px; font-size: 11px; color: var(--purple-soft); text-transform: uppercase; letter-spacing: 1px; }
        
        input, textarea, select { 
            width: 100%; 
            padding: 16px; 
            background: #0f0b1e;
            border: 1px solid rgba(255,255,255,0.08);
            color: var(--text-main); 
            border-radius: 14px; 
            font-size: 14px; 
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus { 
            outline: none; 
            border-color: var(--purple-soft); 
            box-shadow: 0 0 25px var(--purple-glow);
            background: #15102b;
        }

        /* BUTTONS - AUTHORITATIVE */
        .btn-new-rpm { 
            width: 100%; padding: 16px; 
            background: linear-gradient(90deg, var(--purple-main), var(--purple-soft));
            color: white; border: none; border-radius: 15px; 
            cursor: pointer; font-weight: 800; margin-bottom: 20px; 
            box-shadow: 0 10px 30px var(--purple-glow); 
            transition: 0.3s ease; 
        }
        .btn-new-rpm:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(139, 92, 246, 0.4); }

        .btn-add { 
            background: var(--bg-main); 
            color: var(--purple-soft); 
            border: 1px solid var(--purple-main);
            padding: 18px 35px; border-radius: 15px; cursor: pointer; font-weight: 800; margin-top: 20px;
            transition: 0.3s; 
        }
        .btn-add:hover { background: var(--purple-main); color: white; box-shadow: 0 0 20px var(--purple-glow); }

        /* LIST ITEM */
        .rpm-item { 
            padding: 16px; 
            background: rgba(255,255,255,0.03); 
            margin-bottom: 10px; 
            border-radius: 15px; 
            cursor: pointer; 
            font-size: 13px; 
            transition: 0.3s ease;
            display: flex; justify-content: space-between; align-items: center;
            color: var(--text-muted);
            border: 1px solid transparent;
        }
        .rpm-item:hover { background: rgba(139, 92, 246, 0.1); color: #fff; border-color: rgba(139, 92, 246, 0.3); }
        .rpm-item.active { 
            background: linear-gradient(90deg, var(--purple-main), var(--purple-soft));
            color: white; 
            box-shadow: 0 10px 25px var(--purple-glow);
            border: none;
        }

        /* 3M CARDS - DEPTH UPGRADE */
        .pertemuan-card { 
            background: rgba(255,255,255,0.02);
            padding: 30px; 
            margin-bottom: 40px; 
            border-radius: 25px; 
            border: 1px solid rgba(255,255,255,0.05);
            transition: 0.4s;
        }
        .pertemuan-card:hover { transform: scale(1.01); background: rgba(255,255,255,0.04); box-shadow: 0 30px 60px rgba(0,0,0,0.4); }
        
        .m-box { padding: 25px; border-radius: 18px; margin-top: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .mindful { background: rgba(34, 197, 94, 0.05); border-left: 4px solid var(--accent-green); }
        .meaningful { background: rgba(139, 92, 246, 0.05); border-left: 4px solid var(--purple-soft); }
        .joyful { background: rgba(230, 126, 34, 0.05); border-left: 4px solid var(--accent-orange); }

        /* NOTIFICATION */
        .save-notif { 
            position: fixed; bottom: 40px; right: 40px; 
            background: var(--purple-main); color: white; 
            padding: 15px 35px; border-radius: 50px; 
            font-size: 13px; font-weight: 800; display: none; z-index: 1000; 
            box-shadow: 0 15px 40px var(--purple-glow);
            border: 1px solid var(--purple-soft);
        }

        /* EXPORT BOX */
        .action-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 60px; }
        .btn-download { 
            padding: 22px; color: #fff; border: none; border-radius: 18px; 
            font-size: 14px; font-weight: 900; cursor: pointer; transition: 0.3s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-word { background: #2b579a; box-shadow: 0 10px 25px rgba(43, 87, 154, 0.3); }
        .btn-pdf { background: #e74c3c; box-shadow: 0 10px 25px rgba(231, 76, 60, 0.3); }
        .btn-download:hover { transform: translateY(-5px); filter: brightness(1.2); }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-main); }
        ::-webkit-scrollbar-thumb { background: var(--purple-main); border-radius: 10px; }
    </style>
</head>
<body>

<div class="save-notif" id="saveNotif">SYSTEM UPDATED âœ“</div>

<div class="wrapper">
    <div class="sidebar">
        <div class="brand-box">
            <div class="brand-title">SIPANDU RPM</div>
            <p style="color: var(--purple-soft); font-size: 10px; font-weight: 800; letter-spacing: 2px; margin-top: 5px;">AUTHORITY MODE</p>
            <div class="reflective-note">
                "Mendidik adalah menuntun segala kodrat yang ada pada anak-anak."
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 25px;">
            <button onclick="undo()" style="flex:1; background: #1c153a; color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; cursor: pointer;">â†¶</button>
            <button onclick="redo()" style="flex:1; background: #1c153a; color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; cursor: pointer;">â†·</button>
        </div>

        <label style="color: var(--text-muted); font-size: 9px;">Subject Selection</label>
        <select id="sidebarMapel" onchange="filterByMapel()" style="margin-bottom: 25px; border-color: var(--purple-main);">
            <option value="Matematika">Matematika</option>
            <option value="Bahasa Indonesia">Bahasa Indonesia</option>
            <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
            <option value="IPAS">IPAS</option>
            <option value="PJOK">PJOK</option>
            <option value="Seni Budaya">Seni Budaya</option>
            <option value="Bahasa Inggris">Bahasa Inggris</option>
            <option value="Pendidikan Agama dan BP">Pendidikan Agama dan BP</option>
            <option value="Mulok Bahasa Jawa">Mulok Bahasa Jawa</option>
        </select>

        <button class="btn-new-rpm" onclick="createNewRPM()">+ INITIATE NEW CHAPTER</button>
        <ul class="rpm-list" id="rpmList"></ul>
    </div>

    <div class="main-content">
        <div class="container" id="formContainer" style="display:none;">
            <div class="header">
                <p>Curriculum Design Matrix</p>
                <h1>RENCANA PEMBELAJARAN MENDALAM</h1>
            </div>

            <form id="rpmForm" oninput="handleInput()">
                <h2>I. CORE IDENTITY</h2>
                <div class="grid-id">
                    <div class="full"><label>Institution</label><input type="text" id="sekolah"></div>
                    <div class="full"><label>Chapter / Topic Title</label><input type="text" id="bab" oninput="updateSidebarLabel(this.value)"></div>
                    <div><label>Subject</label><input type="text" id="mapel" readonly style="opacity: 0.6;"></div>
                    <div><label>Fase</label><select id="fase"><option>A</option><option>B</option><option>C</option></select></div>
                    <div><label>Time Allocation</label><input type="text" id="alokasi" placeholder="e.g. 4 JP"></div>
                </div>

                <h2>II. OBJECTIVES & INDICATORS</h2>
                <div style="margin-top: 20px;">
                    <label>Learning Objectives (TP)</label>
                    <textarea id="tp" style="height: 120px;"></textarea>
                </div>
                <div style="margin-top: 25px;">
                    <label>Success Indicators (IKTP)</label>
                    <textarea id="iktp" style="height: 100px;"></textarea>
                </div>

                <h2>III. 3M LEARNING MATRIX</h2>
                <div id="pertemuanContainer"></div>
                <button type="button" class="btn-add" onclick="addPertemuan()">+ ADD SESSION LAYER</button>

                <h2>IV. ASSESSMENT STRATEGY</h2>
                <div class="grid-id">
                    <div><label>Diagnostic</label><textarea id="as_awal"></textarea></div>
                    <div><label>Process</label><textarea id="as_proses"></textarea></div>
                    <div><label>Summative</label><textarea id="as_akhir"></textarea></div>
                </div>

                <div class="action-container">
                    <button type="button" class="btn-download btn-word" onclick="downloadDoc()">GENERATE WORD</button>
                    <button type="button" class="btn-download btn-pdf" onclick="downloadPDF()">GENERATE PDF</button>
                </div>
            </form>
        </div>

        <div id="emptyState" style="text-align:center; padding-top:150px; opacity: 0.5;">
            <div style="font-size: 80px; filter: grayscale(1);">ðŸ”®</div>
            <h2 style="background:none; border:none; text-align:center; color: var(--text-muted);">Please select a chapter from the sidebar<br>or initiate a new command.</h2>
        </div>
    </div>
</div>

<script>
    /* JAVASCRIPT LOGIC TETAP SAMA AGAR TIDAK ERROR */
    let db = JSON.parse(localStorage.getItem('rpm_db_v5')) || [];
    let currentId = null;
    let historyStack = [];
    let redoStack = [];
    let typingTimer;

    window.onload = () => { filterByMapel(); };

    function handleInput() {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => { saveCurrentData(); }, 1000);
    }

    function filterByMapel() {
        renderSidebar();
    }

    function renderSidebar() {
        const selectedMapel = document.getElementById('sidebarMapel').value;
        const list = document.getElementById('rpmList');
        list.innerHTML = '';
        const filtered = db.filter(x => x.mapel === selectedMapel);
        filtered.forEach(item => {
            const li = document.createElement('li');
            li.className = `rpm-item ${currentId === item.id ? 'active' : ''}`;
            li.onclick = () => loadRPM(item.id);
            li.innerHTML = `<span>${item.bab || 'Untitled'}</span><span onclick="event.stopPropagation(); deleteRPM('${item.id}')" style="opacity:0.5">Ã—</span>`;
            list.appendChild(li);
        });
    }

    function createNewRPM() {
        const selectedMapel = document.getElementById('sidebarMapel').value;
        const newId = 'id_' + Date.now();
        db.push({ 
            id: newId, mapel: selectedMapel, bab: 'New Chapter', 
            pertemuan: [{mindful:'', meaningful:'', joyful:'', tanggal:'', jp:''}]
        });
        localStorage.setItem('rpm_db_v5', JSON.stringify(db));
        loadRPM(newId);
    }

    function loadRPM(id) {
        currentId = id;
        const data = db.find(x => x.id === id);
        if (!data) return;
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('formContainer').style.display = 'block';
        
        document.getElementById('mapel').value = data.mapel;
        document.getElementById('bab').value = data.bab;
        document.getElementById('tp').value = data.tp || '';
        document.getElementById('iktp').value = data.iktp || '';
        document.getElementById('sekolah').value = data.sekolah || '';
        document.getElementById('alokasi').value = data.alokasi || '';
        
        const container = document.getElementById('pertemuanContainer');
        container.innerHTML = '';
        (data.pertemuan || []).forEach((p, idx) => renderPertemuan(idx + 1, p.mindful, p.meaningful, p.joyful, p.tanggal, p.jp));
        renderSidebar();
    }

    function renderPertemuan(num, m1='', m2='', m3='', tgl='', jp='') {
        const div = document.createElement('div');
        div.className = 'pertemuan-card';
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <label style="color:var(--purple-soft); font-size:14px;">Session Matrix #${num}</label>
                <input type="text" class="p_tanggal" placeholder="Date" value="${tgl}" style="max-width:150px; padding:8px;">
            </div>
            <div class="m-box mindful"><label>Mindful Stage</label><textarea class="p_mindful" placeholder="Set the tone...">${m1}</textarea></div>
            <div class="m-box meaningful"><label>Meaningful Stage</label><textarea class="p_meaningful" style="height:100px;" placeholder="Core concept delivery...">${m2}</textarea></div>
            <div class="m-box joyful"><label>Joyful Stage</label><textarea class="p_joyful" placeholder="Reflect & celebrate...">${m3}</textarea></div>
        `;
        document.getElementById('pertemuanContainer').appendChild(div);
    }

    function addPertemuan() {
        renderPertemuan(document.querySelectorAll('.pertemuan-card').length + 1);
        saveCurrentData();
    }

    function saveCurrentData() {
        if (!currentId) return;
        const index = db.findIndex(x => x.id === currentId);
        db[index].bab = document.getElementById('bab').value;
        db[index].tp = document.getElementById('tp').value;
        db[index].iktp = document.getElementById('iktp').value;
        db[index].sekolah = document.getElementById('sekolah').value;
        db[index].alokasi = document.getElementById('alokasi').value;
        
        let pData = [];
        document.querySelectorAll('.pertemuan-card').forEach(c => {
            pData.push({ 
                mindful: c.querySelector('.p_mindful').value, 
                meaningful: c.querySelector('.p_meaningful').value, 
                joyful: c.querySelector('.p_joyful').value,
                tanggal: c.querySelector('.p_tanggal').value
            });
        });
        db[index].pertemuan = pData;
        localStorage.setItem('rpm_db_v5', JSON.stringify(db));
        
        const notif = document.getElementById('saveNotif');
        notif.style.display = 'block';
        setTimeout(() => notif.style.display = 'none', 1500);
        renderSidebar();
    }

    function updateSidebarLabel(v) { 
        const active = document.querySelector('.rpm-item.active span');
        if(active) active.innerText = v || 'Untitled';
    }

    function deleteRPM(id) {
        if(confirm('Delete chapter?')) {
            db = db.filter(x => x.id !== id);
            localStorage.setItem('rpm_db_v5', JSON.stringify(db));
            location.reload();
        }
    }

    function downloadPDF() {
        const element = document.getElementById('rpmForm');
        html2pdf().from(element).set({
            margin: 10,
            filename: 'RPM_AUTHORITY.pdf',
            html2canvas: { scale: 2, backgroundColor: '#ffffff' },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).save();
    }
</script>

</body>
</html>
