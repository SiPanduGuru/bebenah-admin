<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SiPandu RPM ‚Äì Ruang Kerja Pribadi</title>
    <style>
        :root {
            /* GLOBAL: Tetap Gelap (Anchor) */
            --bg-main: #0f0b1e; 
            --bg-sidebar: #120d2a;
            
            /* REVISI VISUAL: Area kerja lebih terang & "bernafas" (Indigo Deep) */
            --bg-form: linear-gradient(180deg, #2b2468, #362f7d);
            
            /* Input disesuaikan dikit biar tetep kontras di atas bg baru */
            --bg-input: #1e1842; 
            
            /* Aksen tetap */
            --purple-main: #6d28d9; 
            --purple-soft: #a78bfa; /* Sedikit lebih terang biar kebaca di bg baru */
            --cyan-glow: #22d3ee;
            --orange-glow: #fb923c;
            --text-main: #f5f3ff;
            --accent-green: #4ade80;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-main); margin: 0; color: var(--text-main); overflow: hidden; }
        .wrapper { display: flex; height: 100vh; }
        
        /* SIDEBAR (Tetap Gelap sebagai Anchor) */
        .sidebar { width: 320px; background: var(--bg-sidebar); padding: 30px; border-right: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; }
        .brand-title { font-size: 22px; font-weight: 900; color: var(--cyan-glow); letter-spacing: 2px; margin-bottom: 5px; }
        .brand-sub { font-size: 10px; color: var(--text-main); opacity: 0.5; letter-spacing: 1px; margin-bottom: 20px; text-transform: uppercase;}
        
        .rpm-list { list-style: none; padding: 0; margin-top: 20px; overflow-y: auto; flex-grow: 1; }
        .rpm-item { padding: 12px; background: rgba(255,255,255,0.03); margin-bottom: 8px; border-radius: 10px; cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .rpm-item.active { background: var(--cyan-glow); color: #000; font-weight: bold; box-shadow: 0 0 15px rgba(34, 211, 238, 0.4); }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 40px; overflow-y: auto; background: radial-gradient(circle at top right, #1a1440, #0f0b1e); }
        
        /* REVISI CONTAINER: Depth & Lifting */
        .container { 
            max-width: 900px; 
            margin: auto; 
            background: var(--bg-form); 
            padding: 50px; 
            border-radius: 30px; 
            
            /* Magic Shadow: Inner glow ungu tipis + drop shadow tebal */
            box-shadow:
                0 30px 60px rgba(0,0,0,0.45),
                inset 0 0 0 1px rgba(255,255,255,0.05),
                inset 0 0 40px rgba(139,92,246,0.1);
                
            border: 1px solid rgba(255,255,255,0.05); 
        }
        
        h2 { background: linear-gradient(90deg, var(--purple-main), transparent); padding: 12px; font-size: 13px; border-radius: 8px; margin-top: 40px; border-left: 4px solid var(--cyan-glow); text-transform: uppercase; letter-spacing: 1px; }

        .grid-id { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; background: rgba(0,0,0,0.15); padding: 25px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.03); }
        .full { grid-column: span 3; }
        label { display: block; font-weight: 700; font-size: 11px; color: var(--purple-soft); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input, textarea, select { width: 100%; padding: 14px; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 10px; font-size: 14px; box-sizing: border-box; transition: 0.3s; }
        input:focus, textarea:focus { border-color: var(--cyan-glow); outline: none; background: rgba(30, 24, 66, 0.8); box-shadow: 0 0 10px rgba(34, 211, 238, 0.1); }

        .profil-grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
        .pertemuan-card { background: rgba(255,255,255,0.05); padding: 25px; margin-top: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); }
        
        /* Steps Styling */
        .m-box { padding: 15px; border-radius: 12px; margin-top: 15px; border-left: 4px solid; }
        .step-awal { border-left-color: var(--cyan-glow); background: rgba(34, 211, 238, 0.05); }
        .step-inti { border-left-color: var(--purple-soft); background: rgba(167, 139, 250, 0.05); }
        .step-akhir { border-left-color: var(--orange-glow); background: rgba(251, 146, 60, 0.05); }

        .btn-word { background: #3b82f6; color: white; width: 100%; font-size: 16px; margin-top: 50px; padding: 15px; border-radius: 12px; border: none; cursor: pointer; font-weight: 800; transition: 0.3s; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
        .btn-word:hover { background: #2563eb; transform: translateY(-2px); }
        
        .save-notif { position: fixed; bottom: 20px; right: 20px; background: var(--accent-green); color: #000; font-weight:bold; padding: 10px 25px; border-radius: 50px; font-size: 12px; display: none; z-index: 9999; box-shadow: 0 0 20px rgba(74, 222, 128, 0.4); }
        
        #tpModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; justify-content:center; align-items:center; }
        .modal-content { background: #1c153a; padding:30px; border-radius:20px; width:90%; max-width:600px; border: 1px solid var(--cyan-glow); box-shadow: 0 0 30px rgba(34, 211, 238, 0.2); }
    </style>
</head>
<body>

<div id="tpModal">
    <div class="modal-content">
        <h3 style="color:var(--cyan-glow); margin-top:0;">Pilih Tujuan Pembelajaran</h3>
        <div id="tpChoiceContainer" style="max-height: 350px; overflow-y: auto; margin-bottom: 20px;"></div>
        <div style="text-align: right;">
            <button onclick="document.getElementById('tpModal').style.display='none'" style="color:white; background:none; border:none; cursor:pointer; margin-right:20px;">Batal</button>
            <button onclick="confirmImportTP()" style="padding:10px 20px; background:var(--cyan-glow); color:#000; font-weight:bold; border:none; border-radius:8px; cursor:pointer;">Masukan ke Modul</button>
        </div>
    </div>
</div>

<div class="save-notif" id="saveNotif">PERUBAHAN DISIMPAN ‚úì</div>

<div class="wrapper">
    <div class="sidebar">
        <div class="brand-title">SIPANDU RPM</div>
        <div class="brand-sub">RUANG KERJA PRIBADI</div>
        
        <select id="sidebarMapel" onchange="filterByMapel()" style="margin-bottom: 20px;">
            <option>Matematika</option><option>Bahasa Indonesia</option><option>Pendidikan Pancasila</option>
            <option>IPAS</option><option>PJOK</option><option>Seni Budaya</option>
            <option>Bahasa Inggris</option><option>Pendidikan Agama dan BP</option><option>Mulok Bahasa Jawa</option>
        </select>
        
        <button onclick="createNewRPM()" style="padding:15px; background:var(--cyan-glow); color:#000; border:none; border-radius:12px; cursor:pointer; font-weight:800; box-shadow: 0 0 15px rgba(34, 211, 238, 0.2); transition:0.3s;">+ BUAT MODUL BARU</button>
        
        <ul class="rpm-list" id="rpmList"></ul>
    </div>

    <div class="main-content">
        <div class="container" id="formContainer" style="display:none;">
            <div style="text-align:center; margin-bottom: 40px;">
                <h1 style="margin:0; text-shadow: 0 2px 10px rgba(0,0,0,0.3);">MODUL AJAR / RPP</h1>
                <p style="color:var(--purple-soft); letter-spacing: 2px; font-weight:500;">ALUR KERJA PEMBELAJARAN PRIBADI</p>
            </div>

            <form id="rpmForm" oninput="handleInput()">
                <h2>I. IDENTITAS MODUL</h2>
                <div class="grid-id">
                    <div class="full"><label>Satuan Pendidikan</label><input type="text" id="sekolah"></div>
                    <div class="full"><label>Judul Bab / Materi Pokok</label><input type="text" id="bab" oninput="updateSidebarLabel(this.value)"></div>
                    <div><label>Mata Pelajaran</label><input type="text" id="mapel" readonly></div>
                    <div><label>Fase</label><select id="fase"><option>A</option><option>B</option><option>C</option></select></div>
                    <div><label>Kelas</label><select id="kelas"><option>I</option><option>II</option><option>III</option><option>IV</option><option>V</option><option>VI</option></select></div>
                    <div class="full"><label>Alokasi Waktu</label><input type="text" id="alokasi" placeholder="Contoh: 2 x 35 Menit"></div>
                </div>

                <h2>II. KOMPONEN INTI</h2>
                <div style="position:relative; margin-top:15px;">
                    <label>Tujuan Pembelajaran (TP)</label>
                    <button type="button" onclick="importDataDariAdmn()" style="position:absolute; right:0; top:0; background:var(--cyan-glow); color:#000; font-weight:bold; border:none; padding:5px 12px; border-radius:6px; font-size:11px; cursor:pointer;">AMBIL DARI ADMN</button>
                    <textarea id="tp" style="height:100px;"></textarea>
                </div>
                <div style="margin-top:20px;"><label>Indikator Ketercapaian (IKTP)</label><textarea id="iktp" style="height:80px;"></textarea></div>

                <h2>III. PROFIL PELAJAR (P5)</h2>
                <div id="profilContainer" class="profil-grid"></div>

                <h2>IV. PEMANTIK & MEDIA</h2>
                <div class="grid-id">
                    <div class="full"><label>Pertanyaan Pemantik</label><textarea id="pemantik"></textarea></div>
                    <div class="full"><label>Media & Sumber Belajar</label><textarea id="bermakna" placeholder="Alat peraga, video, buku sumber, dll..."></textarea></div>
                </div>

                <h2>V. LANGKAH PEMBELAJARAN</h2>
                <div id="pertemuanContainer"></div>
                <button type="button" onclick="addPertemuan()" style="width:100%; padding:15px; background:rgba(255,255,255,0.05); border:1px solid var(--cyan-glow); color:var(--cyan-glow); border-radius:12px; margin-top:20px; cursor:pointer; transition:0.3s; font-weight:600;">+ TAMBAH PERTEMUAN</button>

                <h2>VI. ASESMEN & LAMPIRAN</h2>
                <div class="grid-id">
                    <div class="full"><label>Strategi Diferensiasi (Opsional)</label><textarea id="diff_umum"></textarea></div>
                    <div><label>Asesmen Awal</label><textarea id="as_awal"></textarea></div>
                    <div><label>Asesmen Formatif</label><textarea id="as_proses"></textarea></div>
                    <div><label>Asesmen Sumatif</label><textarea id="as_akhir"></textarea></div>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:40px;">
                    <div><label>Guru Penyusun</label><input type="text" id="guru"></div>
                    <div><label>Kepala Sekolah</label><input type="text" id="ks"></div>
                </div>

                <button type="button" class="btn-word" onclick="downloadDoc()">DOWNLOAD DOKUMEN (.DOC)</button>
            </form>
        </div>
        <div id="emptyState" style="text-align:center; margin-top:200px; opacity:0.3;">
            <div style="font-size:80px; color:var(--cyan-glow); filter: drop-shadow(0 0 20px rgba(34,211,238,0.5));">üìù</div>
            <h2 style="background:none; border:none; margin-top:20px; color:var(--text-main);">Pilih atau Buat Modul Baru</h2>
        </div>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('rpm_db_general_v1')) || [];
    let currentId = null;
    let typingTimer;
    let tempTpList = [];
    const dimensiList = ["Beriman & Bertakwa", "Berkebinekaan Global", "Bernalar Kritis", "Kreatif", "Gotong Royong", "Mandiri"];

    window.onload = () => { initProfil(); filterByMapel(); };

    function initProfil() {
        document.getElementById('profilContainer').innerHTML = dimensiList.map((d, i) => `
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <input type="checkbox" id="chk_${i}" onchange="toggleDim(${i})"> ${d}
                </label>
                <div id="inp_${i}" style="display:none; margin-top:10px;">
                    <textarea id="txt_${i}" placeholder="Fokus perilaku/kegiatan?"></textarea>
                </div>
            </div>`).join('');
    }

    function toggleDim(i) {
        document.getElementById(`inp_${i}`).style.display = document.getElementById(`chk_${i}`).checked ? 'block' : 'none';
        saveData();
    }

    function filterByMapel() {
        const sel = document.getElementById('sidebarMapel').value;
        const list = document.getElementById('rpmList');
        list.innerHTML = '';
        db.filter(x => x.mapel === sel).forEach(item => {
            const li = document.createElement('li');
            li.className = `rpm-item ${currentId === item.id ? 'active' : ''}`;
            li.onclick = () => loadRPM(item.id);
            li.innerHTML = `<span>${item.bab}</span><span onclick="event.stopPropagation(); deleteRPM('${item.id}')">√ó</span>`;
            list.appendChild(li);
        });
    }

    function createNewRPM() {
        const id = 'modul_' + Date.now();
        const mapel = document.getElementById('sidebarMapel').value;
        db.push({ id, mapel, bab: 'Materi Baru', pertemuan: [{awal:'', inti:'', akhir:'', tanggal:'', jp:''}], profils: {} });
        saveData();
        loadRPM(id);
    }

    function loadRPM(id) {
        currentId = id;
        const data = db.find(x => x.id === id);
        if(!data) return;
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('formContainer').style.display = 'block';
        document.getElementById('mapel').value = data.mapel;
        
        const fields = ['sekolah','bab','fase','kelas','alokasi','tp','iktp','pemantik','bermakna','diff_umum','as_awal','as_proses','as_akhir','guru','ks'];
        fields.forEach(f => document.getElementById(f).value = data[f] || '');
        
        dimensiList.forEach((_, i) => {
            const has = data.profils && data.profils[i];
            document.getElementById(`chk_${i}`).checked = !!has;
            document.getElementById(`inp_${i}`).style.display = has ? 'block' : 'none';
            document.getElementById(`txt_${i}`).value = has ? data.profils[i] : '';
        });

        document.getElementById('pertemuanContainer').innerHTML = '';
        (data.pertemuan || []).forEach((p, idx) => renderPertemuan(idx + 1, p));
        filterByMapel();
    }

    function renderPertemuan(num, p={}) {
        const div = document.createElement('div');
        div.className = 'pertemuan-card';
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <label style="color:var(--text-main)">PERTEMUAN KE-${num}</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" class="p_tgl" placeholder="Tanggal" value="${p.tanggal||''}" style="width:120px;">
                    <input type="text" class="p_jp" placeholder="JP" value="${p.jp||''}" style="width:60px;">
                </div>
            </div>
            <div class="m-box step-awal"><label style="color:var(--cyan-glow)">KEGIATAN PENDAHULUAN (Apersepsi & Motivasi)</label><textarea class="p_awal">${p.awal||''}</textarea></div>
            <div class="m-box step-inti"><label style="color:var(--purple-soft)">KEGIATAN INTI</label><textarea class="p_inti" style="height:120px;">${p.inti||''}</textarea></div>
            <div class="m-box step-akhir"><label style="color:var(--orange-glow)">KEGIATAN PENUTUP (Refleksi)</label><textarea class="p_akhir">${p.akhir||''}</textarea></div>`;
        document.getElementById('pertemuanContainer').appendChild(div);
    }

    function addPertemuan() { renderPertemuan(document.querySelectorAll('.pertemuan-card').length + 1); saveData(); }
    function handleInput() { clearTimeout(typingTimer); typingTimer = setTimeout(saveData, 1000); }

    function saveData() {
        if(!currentId) return;
        const idx = db.findIndex(x => x.id === currentId);
        const fields = ['sekolah','bab','mapel','fase','kelas','alokasi','tp','iktp','pemantik','bermakna','diff_umum','as_awal','as_proses','as_akhir','guru','ks'];
        fields.forEach(f => db[idx][f] = document.getElementById(f).value);
        db[idx].profils = {};
        dimensiList.forEach((_, i) => { if(document.getElementById(`chk_${i}`).checked) db[idx].profils[i] = document.getElementById(`txt_${i}`).value; });
        db[idx].pertemuan = Array.from(document.querySelectorAll('.pertemuan-card')).map(c => ({
            awal: c.querySelector('.p_awal').value, 
            inti: c.querySelector('.p_inti').value,
            akhir: c.querySelector('.p_akhir').value, 
            tanggal: c.querySelector('.p_tgl').value, 
            jp: c.querySelector('.p_jp').value
        }));
        localStorage.setItem('rpm_db_general_v1', JSON.stringify(db));
        const n = document.getElementById('saveNotif'); n.style.display='block'; setTimeout(()=>n.style.display='none', 1000);
    }

    function importDataDariAdmn() {
        const raw = localStorage.getItem('sipandu_v1_4');
        if(!raw) return alert("Data ADMN belum tersedia.");
        const data = JSON.parse(raw);
        const mapelNow = document.getElementById('mapel').value;
        tempTpList = (data.subjects[mapelNow] || {}).tpList || [];
        if(!tempTpList.length) return alert("Belum ada TP untuk mapel ini di Data ADMN.");
        document.getElementById('tpChoiceContainer').innerHTML = tempTpList.map((t, i) => `<label style="display:flex; gap:10px; padding:10px; border-bottom:1px solid rgba(255,255,255,0.1); cursor:pointer;"><input type="checkbox" class="tp-sel" value="${i}"> ${t.text}</label>`).join('');
        document.getElementById('tpModal').style.display = 'flex';
        ['sekolah','guru','ks'].forEach(f => { if(!document.getElementById(f).value) document.getElementById(f).value = data.common[f]; });
    }

    function confirmImportTP() {
        const sels = Array.from(document.querySelectorAll('.tp-sel:checked')).map(c => tempTpList[c.value].text);
        document.getElementById('tp').value = (document.getElementById('tp').value ? document.getElementById('tp').value + "\n" : "") + sels.join("\n");
        document.getElementById('tpModal').style.display = 'none';
        saveData();
    }

    function downloadDoc() {
        const data = db.find(x => x.id === currentId);
        if(!data) return;

        let profHtml = "";
        dimensiList.forEach((d, i) => { if(data.profils[i]) profHtml += `<tr><td width="30%"><b>${d}</b></td><td>${data.profils[i]}</td></tr>`; });

        let langHtml = "";
        data.pertemuan.forEach((p, i) => {
            langHtml += `<tr bgcolor="#f2f2f2"><td colspan="2" align="center"><b>PERTEMUAN KE-${i+1} (${p.tanggal || '-'}) | ${p.jp || '-'} JP</b></td></tr>
            <tr><td width="150" bgcolor="#e0f7fa"><b>PENDAHULUAN</b></td><td>${p.awal.replace(/\n/g, '<br>')}</td></tr>
            <tr><td bgcolor="#f3e5f5"><b>INTI</b></td><td>${p.inti.replace(/\n/g, '<br>')}</td></tr>
            <tr><td bgcolor="#fff3e0"><b>PENUTUP</b></td><td>${p.akhir.replace(/\n/g, '<br>')}</td></tr>`;
        });

        const html = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'>
        <head><meta charset='utf-8'><style>
            @page Section1 { size: 21.59cm 33.02cm; margin: 1.5cm; }
            div.Section1 { page: Section1; }
            body { font-family: 'Arial'; font-size: 11pt; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
            td, th { border: 1px solid black; padding: 6px; vertical-align: top; }
        </style></head>
        <body><div class="Section1">
            <h2 align="center">MODUL AJAR / RPP</h2>
            <table>
                <tr><td width="150">Sekolah</td><td>${data.sekolah}</td><td width="100">Kelas/Fase</td><td>${data.kelas} / ${data.fase}</td></tr>
                <tr><td>Mata Pelajaran</td><td>${data.mapel}</td><td>Alokasi</td><td>${data.alokasi}</td></tr>
                <tr><td>Bab / Topik</td><td colspan="3"><b>${data.bab}</b></td></tr>
            </table>
            <h3>I. KOMPONEN INTI</h3>
            <table>
                <tr><td width="30%"><b>Tujuan Pembelajaran</b></td><td>${data.tp.replace(/\n/g, '<br>')}</td></tr>
                <tr><td><b>Indikator (IKTP)</b></td><td>${data.iktp.replace(/\n/g, '<br>')}</td></tr>
                <tr><td><b>Pertanyaan Pemantik</b></td><td>${data.pemantik.replace(/\n/g, '<br>')}</td></tr>
                <tr><td><b>Media/Sumber Belajar</b></td><td>${data.bermakna.replace(/\n/g, '<br>')}</td></tr>
            </table>
            <h3>II. PROFIL PELAJAR (P5)</h3>
            <table>${profHtml || '<tr><td colspan="2">-</td></tr>'}</table>
            <h3>III. LANGKAH PEMBELAJARAN</h3>
            <table>${langHtml}</table>
            <h3>IV. ASESMEN (PENILAIAN)</h3>
            <table>
                <tr><td width="30%"><b>Asesmen Awal</b></td><td>${data.as_awal}</td></tr>
                <tr><td><b>Asesmen Formatif (Proses)</b></td><td>${data.as_proses}</td></tr>
                <tr><td><b>Asesmen Sumatif (Akhir)</b></td><td>${data.as_akhir}</td></tr>
                <tr><td><b>Catatan Diferensiasi</b></td><td>${data.diff_umum.replace(/\n/g, '<br>')}</td></tr>
            </table>
            <br>
            <table style="border:none;">
                <tr style="border:none;"><td align="center" style="border:none;">Mengetahui,<br>Kepala Sekolah<br><br><br><b>${data.ks}</b></td>
                <td align="center" style="border:none;">Guru Penyusun<br><br><br><br><b>${data.guru}</b></td></tr>
            </table>
        </div></body></html>`;

        const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `MODUL_${data.bab.replace(/[/\\?%*:|"<>]/g, '-')}.doc`;
        a.click();
    }

    function updateSidebarLabel(v) { const el = document.querySelector('.rpm-item.active span'); if(el) el.innerText = v || 'Materi Baru'; }
    function deleteRPM(id) { if(confirm('Hapus Modul ini?')) { db = db.filter(x => x.id !== id); localStorage.setItem('rpm_db_general_v1', JSON.stringify(db)); location.reload(); } }
</script>
</body>
</html>
