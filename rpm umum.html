<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SiPandu RPM - Integritas dalam Proses, Profesional dalam Praktik </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* DNA SIPANDU - MATCHING WITH INDEX */
        :root { 
            --primary: #00695c; 
            --secondary: #004d40; 
            --hint: #78909c; 
            --bg: #f0f4f4; 
            --accent: #e67e22; 
            --sidebar-bg: #1a232e;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.08);
            --input-focus: rgba(0, 105, 92, 0.1);
        }

        body { 
            font-family: 'Inter', 'Segoe UI', Tahoma, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 0; 
            color: #333; 
            line-height: 1.6; 
        }
        
        /* SIDEBAR DNA */
        .wrapper { display: flex; min-height: 100vh; }
        .sidebar { 
            width: 300px; 
            background: var(--sidebar-bg); 
            color: white; 
            padding: 25px; 
            box-shadow: 2px 0 15px rgba(0,0,0,0.1); 
            position: sticky; 
            top: 0; 
            height: 100vh; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
        }

        /* BRANDING */
        .brand-box { margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        .brand-title { 
            font-size: 22px; 
            font-weight: 800; 
            color: var(--accent); 
            margin: 0; 
            letter-spacing: 2px;
            font-family: 'Segoe UI Black', sans-serif;
        }
        .reflective-note { 
            font-size: 12px; 
            color: #b0bec5; 
            font-style: italic; 
            margin-top: 12px; 
            border-left: 3px solid var(--primary); 
            padding-left: 12px; 
            line-height: 1.5; 
        }

        /* MAIN CONTENT AREA */
        .main-content { flex: 1; padding: 30px; }
        .container { 
            max-width: 950px; 
            margin: auto; 
            background: #fff; 
            padding: 45px; 
            border-radius: 24px; 
            box-shadow: var(--card-shadow); 
            animation: fadeSlideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* FORM ELEMENTS */
        .header { text-align: center; border-bottom: 5px double var(--primary); margin-bottom: 40px; padding-bottom: 20px; }
        .header h1 { font-weight: 800; letter-spacing: -0.5px; margin-bottom: 5px; }
        
        h2 { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #fff; 
            padding: 12px 20px; 
            font-size: 14px; 
            border-radius: 12px; 
            margin-top: 40px; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            box-shadow: 0 4px 12px rgba(0, 105, 92, 0.2);
        }

        .grid-id { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 20px; 
            background: #fafcfc; 
            padding: 25px; 
            border: 1px solid #edf2f2; 
            border-radius: 16px; 
        }
        .full { grid-column: span 3; }

        label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 12px; color: #546e7a; text-transform: uppercase; }
        input, textarea, select { 
            width: 100%; 
            padding: 14px; 
            border: 1.5px solid #e0e6e6; 
            border-radius: 12px; 
            font-size: 14px; 
            box-sizing: border-box; 
            transition: all 0.3s ease;
            background: #fff;
        }
        input:focus, textarea:focus, select:focus { 
            outline: none; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 4px var(--input-focus); 
        }

        /* PROFIL LULUSAN CARDS */
        .profil-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; }
        .profil-box { 
            background: white; 
            border: 1px solid #eef2f2; 
            padding: 15px; 
            border-radius: 14px; 
            transition: all 0.3s ease;
        }
        .profil-box:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 20px rgba(0,0,0,0.05);
            border-color: var(--primary);
        }
        .profil-check { display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 700; cursor: pointer; color: #37474f; }

        /* PERTEMUAN 3M */
        .pertemuan-card { 
            border: 1.5px solid #e0e6e6; 
            padding: 25px; 
            margin-bottom: 30px; 
            border-radius: 20px; 
            background: #fff; 
            transition: box-shadow 0.3s ease;
        }
        .pertemuan-card:hover { box-shadow: 0 15px 35px rgba(0,0,0,0.07); }
        .pertemuan-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        
        .m-box { padding: 18px; border-radius: 14px; border-left: 6px solid; margin-top: 15px;}
        .mindful { border-left-color: #4caf50; background: #f1f8e9; }
        .meaningful { border-left-color: #2196f3; background: #e3f2fd; }
        .joyful { border-left-color: #ff9800; background: #fff3e0; }

        /* BUTTONS */
        .btn-new-rpm { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 800; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(230, 126, 34, 0.3); transition: 0.3s; }
        .btn-new-rpm:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(230, 126, 34, 0.4); }
        
        .btn-add { background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 12px; cursor: pointer; font-weight: bold; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,105,92,0.2); transition: 0.3s; }
        .btn-add:hover { transform: translateY(-2px); filter: brightness(1.1); }

        .btn-template { background: #546e7a; color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 10px; cursor: pointer; float: right; margin-top: -32px; transition: 0.2s; }
        .btn-template:hover { background: var(--primary); }

        /* SIDEBAR LIST */
        .rpm-list { list-style: none; padding: 0; margin: 0; }
        .rpm-item { 
            padding: 12px 15px; 
            background: #263238; 
            margin-bottom: 8px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 13px; 
            transition: 0.3s; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-left: 0 solid var(--accent);
        }
        .rpm-item:hover { background: #37474f; }
        .rpm-item.active { background: var(--primary); border-left: 5px solid var(--accent); padding-left: 10px; }

        .action-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 50px; }
        .btn-download { padding: 20px; color: #fff; border: none; border-radius: 14px; font-size: 14px; font-weight: 800; cursor: pointer; transition: 0.3s; }
        .btn-word { background: #2b579a; box-shadow: 0 4px 15px rgba(43, 87, 154, 0.3); }
        .btn-pdf { background: #e74c3c; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); }
        .btn-download:hover { transform: translateY(-3px); filter: brightness(1.1); }

        .save-notif { position: fixed; bottom: 30px; right: 30px; background: #2ecc71; color: white; padding: 12px 25px; border-radius: 50px; font-size: 13px; font-weight: bold; display: none; z-index: 1000; box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);}
        
        .history-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 25px; }
        .btn-history { padding: 10px; font-size: 11px; cursor: pointer; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: #37474f; color: white; transition: 0.2s; }
        .btn-history:hover:not(:disabled) { background: #455a64; }

        #tpModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; backdrop-filter: blur(5px); }
        .modal-content { background:white; padding:35px; border-radius:24px; max-width:650px; width:90%; max-height:85vh; overflow-y:auto; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div id="tpModal">
    <div class="modal-content">
        <h2 style="margin-top:0; background:none; color:var(--primary); padding:0; box-shadow:none;">Pilih Tujuan Pembelajaran</h2>
        <p style="color:#666; font-size: 14px; margin-bottom: 20px;">Silakan pilih satu atau beberapa TP yang akan diajarkan pada bab ini.</p>
        <div id="tpChoiceContainer"></div>
        <div class="modal-footer" style="margin-top:25px; display:flex; justify-content:flex-end; gap:12px;">
            <button class="btn-history" style="background:#eee; color:#333; border:none; padding:12px 20px;" onclick="document.getElementById('tpModal').style.display='none'">Batal</button>
            <button class="btn-new-rpm" style="width:auto; margin:0; padding:12px 25px;" onclick="confirmImportTP()">Impor TP Terpilih</button>
        </div>
    </div>
</div>

<div class="save-notif" id="saveNotif">‚úì Tersimpan ke Memori Lokal</div>

<div class="wrapper">
    <div class="sidebar">
        <div class="brand-box">
            <div class="brand-title">SIPANDU GURU</div>
            <small style="color: #b0bec5; font-weight: bold; letter-spacing: 1px;">V.1.0 - Teaching Assistant</small>
            <div class="reflective-note">
                ‚ÄúMendidik adalah menuntun segala kodrat yang ada pada anak-anak.‚Äù
            </div>
        </div>

        <div class="history-controls">
            <button class="btn-history" id="btnUndo" onclick="undo()">‚Ü∂ Undo</button>
            <button class="btn-history" id="btnRedo" onclick="redo()">‚Ü∑ Redo</button>
        </div>

        <label style="font-size: 10px; color: #b0bec5; letter-spacing: 1px;">MATA PELAJARAN</label>
        <select class="mapel-select" id="sidebarMapel" onchange="filterByMapel()" style="background:#263238; color:white; border-color:#455a64; margin-bottom:20px;">
            <option value="Matematika">Matematika</option>
            <option value="Bahasa Indonesia">Bahasa Indonesia</option>
            <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
            <option value="IPAS">IPAS</option>
            <option value="PJOK">PJOK</option>
            <option value="Seni Budaya">Seni Budaya</option>
            <option value="Bahasa Inggris">Bahasa Inggris</option>
            <option value="Pendidikan Agama dan BP">Pendidikan Agama dan BP</option>
            <option value="Mulok Bahasa Jawa">Mulok Bahasa Jawa</option>
        </select>

        <button class="btn-new-rpm" onclick="createNewRPM()">+ BUAT BAB BARU</button>
        <h3 id="labelDaftar" style="font-size: 11px; text-transform: uppercase; color: #78909c; margin-top: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px;">Daftar Bab</h3>
        <ul class="rpm-list" id="rpmList"></ul>
    </div>

    <div class="main-content">
        <div class="container" id="formContainer" style="display:none;">
            <div class="header">
                <small style="color: var(--primary); font-weight: bold; text-transform: uppercase; letter-spacing: 2px;">Teaching Assistant Workspace</small>
                <h1 style="margin-top: 5px; font-weight: 800;">RENCANA PEMBELAJARAN MENDALAM</h1>
                <p style="color: var(--hint); font-style: italic;">"Menyusun langkah, menuntun kodrat murid menuju keselamatan dan kebahagiaan."</p>
            </div>

            <form id="rpmForm" oninput="handleInput()">
                <h2>I. IDENTITAS UMUM</h2>
                <div class="grid-id">
                    <div class="full"><label>Satuan Pendidikan</label><input type="text" id="sekolah" placeholder="Nama Sekolah"></div>
                    <div class="full"><label>Judul RPM / Bab Materi</label><input type="text" id="bab" placeholder="Contoh: Bab 1 - Bilangan Cacah" oninput="updateSidebarLabel(this.value)"></div>
                    <div><label>Mata Pelajaran</label><input type="text" id="mapel" readonly style="background:#f1f5f5; color:#78909c;"></div>
                    <div><label>Fase</label><select id="fase"><option>A</option><option>B</option><option>C</option></select></div>
                    <div><label>Kelas</label><select id="kelas"><option>I</option><option>II</option><option>III</option><option>IV</option><option>V</option><option>VI</option></select></div>
                    <div><label>Alokasi Waktu</label><input type="text" id="alokasi" placeholder="Contoh: 2 x 35 Menit"></div>
                </div>

                <h2>II. TUJUAN & INDIKATOR</h2>
                <div style="position:relative;">
                    <label>Tujuan Pembelajaran (TP)</label>
                    <button type="button" class="btn-template" onclick="importDataDariAdmn()" style="background: #27ae60; margin-right: 90px;">üì• Tarik dari ADMN Guru</button>
                    <button type="button" class="btn-template" onclick="applyTemplate('tp')">Format Baku</button>
                    <textarea id="tp" placeholder="Melalui kegiatan [X], murid dapat [Y]..." style="height:120px;"></textarea>
                </div>
                <div style="position:relative; margin-top:20px;">
                    <label>Tanda Berhasil (IKTP)</label>
                    <button type="button" class="btn-template" onclick="applyTemplate('iktp')">Format Baku</button>
                    <textarea id="iktp" placeholder="1. Murid mampu menjelaskan...&#10;2. Murid dapat mempraktikkan..." style="height:100px;"></textarea>
                </div>

                <h2>III. PROFIL LULUSAN (8 DIMENSI)</h2>
                <div class="profil-grid" id="profilListContainer"></div>

                <h2>IV. PERTANYAAN & MAKNA</h2>
                <div class="grid-id">
                    <div class="full"><label>Pertanyaan Pemantik</label><textarea id="pemantik" placeholder="Pertanyaan yang memancing rasa ingin tahu murid..."></textarea></div>
                    <div class="full"><label>Pemahaman Bermakna</label><textarea id="bermakna" placeholder="Apa manfaat materi ini bagi kehidupan murid nantinya?"></textarea></div>
                </div>

                <h2>V. LANGKAH PEMBELAJARAN (3M)</h2>
                <div id="pertemuanContainer"></div>
                <button type="button" class="btn-add" onclick="addPertemuan()">+ Tambah Kegiatan Pertemuan</button>

                <h2>VI. DIFERENSIASI & ASESMEN</h2>
                <div class="grid-id">
                    <div class="full"><label>Diferensiasi (Strategi Konten/Proses/Produk)</label><textarea id="diff_umum" placeholder="Bagaimana cara mengakomodir murid yang berbeda kemampuan?"></textarea></div>
                    <div><label>Asesmen Awal</label><textarea id="as_awal" placeholder="Kesiapan belajar..."></textarea></div>
                    <div><label>Asesmen Proses</label><textarea id="as_proses" placeholder="Observasi/Formatif..."></textarea></div>
                    <div><label>Asesmen Akhir</label><textarea id="as_akhir" placeholder="Sumatif/Produk..."></textarea></div>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:30px; margin-top:40px; padding: 25px; background: #fafcfc; border-radius: 16px;">
                    <div><label>Guru Penyusun</label><input type="text" id="guru" placeholder="Nama Lengkap & Gelar"></div>
                    <div><label>Kepala Sekolah</label><input type="text" id="ks" placeholder="Nama Kepala Sekolah"></div>
                </div>

                <div class="action-container">
                    <button type="button" class="btn-download btn-word" onclick="downloadDoc()">üìÑ EKSPOR KE MS WORD</button>
                    <button type="button" class="btn-download btn-pdf" onclick="downloadPDF()">üìï SIMPAN SEBAGAI PDF</button>
                </div>
            </form>
        </div>

        <div id="emptyState" style="text-align:center; padding-top:120px; color:#999; animation: fadeIn 1s ease;">
            <div style="font-size: 60px; margin-bottom: 20px;">üìù</div>
            <h3 style="font-weight: 300;">Pilih Mata Pelajaran dan Bab di samping<br>untuk mulai menyusun rencana.</h3>
        </div>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('rpm_db_v5')) || [];
    let currentId = null;
    let historyStack = [];
    let redoStack = [];
    let typingTimer;
    let tempTpList = [];

    const dimensiList = [
        "Keimanan & Ketakwaan", "Kewargaan", "Penalaran Kritis", 
        "Kreativitas", "Kolaborasi", "Kemandirian", "Kesehatan", "Komunikasi"
    ];

    window.onload = () => {
        initProfilGrid();
        filterByMapel();
        updateHistoryButtons();
    };

    function handleInput() {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            saveState(); 
            saveCurrentData(false);
        }, 600);
    }

    function initProfilGrid() {
        const container = document.getElementById('profilListContainer');
        container.innerHTML = dimensiList.map((d, i) => `
            <div class="profil-box">
                <label class="profil-check">
                    <input type="checkbox" id="chk_${i}" onchange="toggleDimensi(${i})"> ${d}
                </label>
                <div class="profil-input" id="inp_${i}" style="display:none; margin-top:10px;">
                    <textarea id="txt_${i}" placeholder="Hubungan dengan aktivitas murid..." style="height:60px; font-size:12px;"></textarea>
                </div>
            </div>
        `).join('');
    }

    function toggleDimensi(index) {
        const isChecked = document.getElementById(`chk_${index}`).checked;
        const inputDiv = document.getElementById(`inp_${index}`);
        inputDiv.style.display = isChecked ? 'block' : 'none';
        if(isChecked && !document.getElementById(`txt_${index}`).value) {
            document.getElementById(`txt_${index}`).value = `Dikembangkan melalui aktivitas murid sesuai tujuan pembelajaran.`;
        }
        saveCurrentData(true);
    }

    function importDataDariAdmn() {
        const dataAdmnRaw = localStorage.getItem('sipandu_v1_4');
        if (!dataAdmnRaw) { alert("Data dari SiPandu ADMN tidak ditemukan."); return; }
        const dataAdmn = JSON.parse(dataAdmnRaw);
        const mapelSekarang = document.getElementById('sidebarMapel').value;
        const subjek = dataAdmn.subjects[mapelSekarang];
        if (!subjek || !subjek.tpList || subjek.tpList.length === 0) { alert("Tidak ada data TP untuk mapel '" + mapelSekarang + "'."); return; }
        tempTpList = subjek.tpList;
        const choiceContainer = document.getElementById('tpChoiceContainer');
        choiceContainer.innerHTML = tempTpList.map((tp, i) => `
            <label class="tp-item-choice" style="display:flex; align-items:center; gap:12px; padding:15px; border-bottom:1px solid #eee; cursor:pointer;">
                <input type="checkbox" class="tp-check" value="${i}" style="width:20px; height:20px;">
                <span style="font-size:14px; color:#444;">${tp.text}</span>
            </label>
        `).join('');
        document.getElementById('tpModal').style.display = 'flex';
        if (!document.getElementById('sekolah').value) document.getElementById('sekolah').value = dataAdmn.common.sekolah;
        if (!document.getElementById('guru').value) document.getElementById('guru').value = dataAdmn.common.guru;
        if (!document.getElementById('ks').value) document.getElementById('ks').value = dataAdmn.common.ks;
    }

    function confirmImportTP() {
        const checked = document.querySelectorAll('.tp-check:checked');
        if (checked.length === 0) { alert("Pilih minimal satu TP."); return; }
        saveState();
        let selectedTexts = [];
        let firstMateri = "";
        checked.forEach(c => {
            const tp = tempTpList[c.value];
            selectedTexts.push(tp.text);
            if(!firstMateri && tp.selectedMateri && tp.selectedMateri.length > 0) firstMateri = tp.selectedMateri.join(', ');
        });
        const currentVal = document.getElementById('tp').value;
        const connector = currentVal ? "\n" : "";
        document.getElementById('tp').value = currentVal + connector + selectedTexts.join('\n');
        if (firstMateri && !document.getElementById('bab').value) {
            document.getElementById('bab').value = firstMateri;
            updateSidebarLabel(firstMateri);
        }
        document.getElementById('tpModal').style.display = 'none';
        saveCurrentData();
    }

    function applyTemplate(type) {
        saveState();
        if(type === 'tp') document.getElementById('tp').value = "Melalui [aktivitas], murid dapat [kompetensi] mengenai [materi] dengan benar.";
        else document.getElementById('iktp').value = "1. Murid mampu menjelaskan...\n2. Murid dapat mempraktikkan...";
        saveCurrentData();
    }

    function saveState() {
        historyStack.push(JSON.stringify(db));
        if (historyStack.length > 20) historyStack.shift();
        redoStack = [];
        updateHistoryButtons();
    }

    function undo() {
        if (historyStack.length > 0) {
            redoStack.push(JSON.stringify(db));
            db = JSON.parse(historyStack.pop());
            syncData();
        }
    }

    function redo() {
        if (redoStack.length > 0) {
            historyStack.push(JSON.stringify(db));
            db = JSON.parse(redoStack.pop());
            syncData();
        }
    }

    function syncData() {
        localStorage.setItem('rpm_db_v5', JSON.stringify(db));
        if (currentId) loadRPM(currentId);
        renderSidebar();
        updateHistoryButtons();
    }

    function updateHistoryButtons() {
        document.getElementById('btnUndo').disabled = historyStack.length === 0;
        document.getElementById('btnRedo').disabled = redoStack.length === 0;
    }

    function filterByMapel() {
        const selectedMapel = document.getElementById('sidebarMapel').value;
        document.getElementById('labelDaftar').innerText = `Daftar Bab ${selectedMapel}`;
        renderSidebar();
    }

    function renderSidebar() {
        const selectedMapel = document.getElementById('sidebarMapel').value;
        const list = document.getElementById('rpmList');
        list.innerHTML = '';
        const filtered = db.filter(x => x.mapel === selectedMapel);
        filtered.forEach(item => {
            const li = document.createElement('li');
            li.className = `rpm-item ${currentId === item.id ? 'active' : ''}`;
            li.onclick = () => loadRPM(item.id);
            li.innerHTML = `<span>${item.bab || 'Bab Baru'}</span><span onclick="event.stopPropagation(); deleteRPM('${item.id}')" style="color:#ff5252; font-weight:bold; font-size:16px;">√ó</span>`;
            list.appendChild(li);
        });
    }

    function createNewRPM() {
        saveState();
        const selectedMapel = document.getElementById('sidebarMapel').value;
        const newId = 'id_' + Date.now();
        db.push({ 
            id: newId, mapel: selectedMapel, bab: 'Bab Baru', 
            pertemuan: [{mindful:'', meaningful:'', joyful:'', tanggal:'', jp:''}], 
            profils: {} 
        });
        syncData();
        loadRPM(newId);
    }

    function loadRPM(id) {
        currentId = id;
        const data = db.find(x => x.id === id);
        if (!data) return;
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('formContainer').style.display = 'block';
        document.getElementById('mapel').value = data.mapel || '';
        const fields = ['sekolah', 'bab', 'fase', 'kelas', 'alokasi', 'tp', 'iktp', 'pemantik', 'bermakna', 'diff_umum', 'as_awal', 'as_proses', 'as_akhir', 'guru', 'ks'];
        fields.forEach(f => { if(document.getElementById(f)) document.getElementById(f).value = data[f] || ''; });
        dimensiList.forEach((_, i) => {
            const chk = document.getElementById(`chk_${i}`);
            const txt = document.getElementById(`txt_${i}`);
            const div = document.getElementById(`inp_${i}`);
            const saved = data.profils && data.profils[i];
            chk.checked = !!saved; div.style.display = saved ? 'block' : 'none'; txt.value = saved ? saved.text : '';
        });
        const container = document.getElementById('pertemuanContainer');
        container.innerHTML = '';
        (data.pertemuan || []).forEach((p, idx) => renderPertemuan(idx + 1, p.mindful, p.meaningful, p.joyful, p.tanggal, p.jp));
        renderSidebar();
    }

    function renderPertemuan(num, m1='', m2='', m3='', tgl='', jp='') {
        const div = document.createElement('div');
        div.className = 'pertemuan-card';
        div.innerHTML = `
            <div class="pertemuan-header">
                <b style="color:var(--primary); font-size:16px;">PERTEMUAN ${num}</b>
                <input type="text" class="p_tanggal" placeholder="Hari/Tanggal" value="${tgl}" style="max-width:200px">
                <input type="text" class="p_jp" placeholder="Jml JP" value="${jp}" style="max-width:100px">
                ${num > 1 ? `<button type="button" onclick="saveState(); this.parentElement.parentElement.remove(); saveCurrentData();" style="color:#e74c3c; border:none; background:none; cursor:pointer; font-size:12px; font-weight:bold;">[Hapus]</button>` : ''}
            </div>
            <div class="m-box mindful"><label style="color:#2e7d32">MINDFUL (Kesadaran Penuh)</label><textarea class="p_mindful" placeholder="Kondisi awal, ice breaking, fokus murid...">${m1}</textarea></div>
            <div class="m-box meaningful"><label style="color:#1565c0">MEANINGFUL (Konten Bermakna)</label><textarea class="p_meaningful" style="height:100px;" placeholder="Langkah inti, eksplorasi konsep...">${m2}</textarea></div>
            <div class="m-box joyful"><label style="color:#ef6c00">JOYFUL (Refleksi & Perayaan)</label><textarea class="p_joyful" placeholder="Perasaan murid, kesimpulan, apresiasi...">${m3}</textarea></div>
        `;
        document.getElementById('pertemuanContainer').appendChild(div);
    }

    function addPertemuan() {
        saveState();
        renderPertemuan(document.querySelectorAll('.pertemuan-card').length + 1);
        saveCurrentData();
    }

    function saveCurrentData(isInstant = false) {
        if (!currentId) return;
        const index = db.findIndex(x => x.id === currentId);
        if (index === -1) return;
        const fields = ['sekolah', 'bab', 'mapel', 'fase', 'kelas', 'alokasi', 'tp', 'iktp', 'pemantik', 'bermakna', 'diff_umum', 'as_awal', 'as_proses', 'as_akhir', 'guru', 'ks'];
        fields.forEach(f => { if(document.getElementById(f)) db[index][f] = document.getElementById(f).value; });
        db[index].profils = {};
        dimensiList.forEach((_, i) => { if(document.getElementById(`chk_${i}`).checked) db[index].profils[i] = { text: document.getElementById(`txt_${i}`).value }; });
        let pData = [];
        document.querySelectorAll('.pertemuan-card').forEach(c => {
            pData.push({ 
                mindful: c.querySelector('.p_mindful').value, 
                meaningful: c.querySelector('.p_meaningful').value, 
                joyful: c.querySelector('.p_joyful').value,
                tanggal: c.querySelector('.p_tanggal').value,
                jp: c.querySelector('.p_jp').value
            });
        });
        db[index].pertemuan = pData;
        localStorage.setItem('rpm_db_v5', JSON.stringify(db));
        showNotif();
    }

    function updateSidebarLabel(v) { 
        const active = document.querySelector('.rpm-item.active span');
        if(active) active.innerText = v || 'Bab Baru';
    }

    function showNotif() {
        const n = document.getElementById('saveNotif');
        n.style.display = 'block';
        setTimeout(() => n.style.display = 'none', 1000);
    }

    function deleteRPM(id) {
        if(confirm('Hapus bab ini secara permanen?')) {
            saveState(); db = db.filter(x => x.id !== id); syncData();
            if(currentId === id) { currentId = null; document.getElementById('formContainer').style.display = 'none'; document.getElementById('emptyState').style.display = 'block'; }
        }
    }

    function downloadDoc() {
        const data = db.find(x => x.id === currentId);
        if(!data) return;
        let profilHtml = "";
        Object.keys(data.profils || {}).forEach(k => { profilHtml += `<li><b>${dimensiList[k]}:</b> ${data.profils[k].text}</li>`; });
        let pertemuanHtml = "";
        (data.pertemuan || []).forEach((p, i) => {
            pertemuanHtml += `
                <tr><td colspan="2" style="background:#f2f2f2; border: 1px solid black;"><b>PERTEMUAN ${i+1} (${p.tanggal || '-'} | ${p.jp || '-'})</b></td></tr>
                <tr><td width="120" style="border: 1px solid black;">Mindful</td><td style="border: 1px solid black;">${p.mindful}</td></tr>
                <tr><td style="border: 1px solid black;">Meaningful</td><td style="border: 1px solid black;">${p.meaningful}</td></tr>
                <tr><td style="border: 1px solid black;">Joyful</td><td style="border: 1px solid black;">${p.joyful}</td></tr>`;
        });
        const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><style>body { font-family: 'Arial'; font-size: 11pt; } table { border-collapse: collapse; width: 100%; margin-bottom: 10px; } td { border: 1px solid black; padding: 8px; vertical-align: top; } .no-border td { border: none !important; }</style></head><body>`;
        const content = `<h2 style="text-align:center">RENCANA PEMBELAJARAN MENDALAM (RPM)</h2><h3>I. IDENTITAS UMUM</h3><table class="no-border"><tr><td width="150">Satuan Pendidikan</td><td>: ${data.sekolah || '-'}</td></tr><tr><td>Mata Pelajaran / Bab</td><td>: ${data.mapel} / ${data.bab}</td></tr><tr><td>Fase / Kelas</td><td>: ${data.fase} / ${data.kelas}</td></tr><tr><td>Alokasi Waktu</td><td>: ${data.alokasi || '-'}</td></tr></table><h3>II. TUJUAN & INDIKATOR</h3><p><b>Tujuan Pembelajaran:</b><br>${data.tp || '-'}</p><p><b>Indikator Ketercapaian (IKTP):</b><br>${data.iktp || '-'}</p><h3>III. PROFIL LULUSAN</h3><ul>${profilHtml || '<li>-</li>'}</ul><h3>IV. PERTANYAAN & MAKNA</h3><p><b>Pertanyaan Pemantik:</b> ${data.pemantik || '-'}</p><p><b>Pemahaman Bermakna:</b> ${data.bermakna || '-'}</p><h3>V. LANGKAH PEMBELAJARAN (3M)</h3><table>${pertemuanHtml}</table><h3>VI. DIFERENSIASI & ASESMEN</h3><p><b>Diferensiasi:</b> ${data.diff_umum || '-'}</p><table><tr><td><b>Asesmen Awal</b></td><td><b>Asesmen Proses</b></td><td><b>Asesmen Akhir</b></td></tr><tr><td>${data.as_awal || '-'}</td><td>${data.as_proses || '-'}</td><td>${data.as_akhir || '-'}</td></tr></table><br><br><table class="no-border"><tr><td width="50%" align="center">Mengetahui,<br>Kepala Sekolah<br><br><br><b>${data.ks || '................'}</b></td><td width="50%" align="center">Guru Penyusun,<br><br><br><br><b>${data.guru || '................'}</b></td></tr></table></body></html>`;
        const blob = new Blob(['\ufeff', header + content], { type: 'application/msword' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `RPM_${data.bab || 'Baru'}.doc`;
        link.click();
    }

    function downloadPDF() {
        const data = db.find(x => x.id === currentId);
        if(!data) return;
        const element = document.createElement('div');
        element.style.padding = "30px";
        element.style.fontFamily = "Arial";
        element.innerHTML = `
            <h1 style="text-align:center; border-bottom: 2px solid #000;">RENCANA PEMBELAJARAN MENDALAM</h1>
            <p><b>Sekolah:</b> ${data.sekolah}</p>
            <p><b>Mata Pelajaran:</b> ${data.mapel}</p>
            <p><b>Bab:</b> ${data.bab}</p>
            <hr>
            <h3>Tujuan Pembelajaran:</h3><p>${data.tp}</p>
            <h3>IKTP:</h3><p>${data.iktp}</p>
            <h3>Langkah 3M:</h3>
            ${data.pertemuan.map((p, i) => `
                <div style="margin-bottom:15px; border:1px solid #ccc; padding:10px;">
                    <b>Pertemuan ${i+1}</b><br>
                    Mindful: ${p.mindful}<br>
                    Meaningful: ${p.meaningful}<br>
                    Joyful: ${p.joyful}
                </div>
            `).join('')}
        `;
        html2pdf().set({
            margin: 10,
            filename: `RPM_${data.bab}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).from(element).save();
    }
</script>

</body>
</html>
