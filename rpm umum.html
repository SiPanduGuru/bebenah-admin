<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SiPandu RPM v2.0 - Deep Learning & Admin Ready</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            /* THEME: Deep Professional v1.1 */
            --bg-main: #f1f5f9;
            --sidebar-bg: #0f172a;
            --sidebar-text: #e2e8f0;
            --card-bg: #ffffff;
            
            --primary: #2563eb;       
            --primary-dark: #1e40af;
            --accent: #38bdf8;
            --danger: #ef4444;
            --success: #10b981;
            
            --text-main: #334155;
            --text-light: #64748b;
            --border: #cbd5e1;
        }

        body { font-family: 'Segoe UI', Inter, sans-serif; background: var(--bg-main); margin: 0; padding: 0; color: var(--text-main); line-height: 1.5; overflow: hidden; }
        
        .wrapper { display: flex; height: 100vh; }
        
        /* SIDEBAR */
        .sidebar { width: 300px; background: var(--sidebar-bg); color: var(--sidebar-text); padding: 25px; display: flex; flex-direction: column; border-right: 1px solid #000; flex-shrink: 0; }
        
        .brand-box { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #334155; }
        .brand-title { font-size: 22px; font-weight: 800; color: var(--accent); letter-spacing: 0.5px; margin: 0; }
        .brand-sub { font-size: 11px; opacity: 0.6; margin-top: 5px; display: block; letter-spacing: 1px; }
        
        .mapel-select { width: 100%; padding: 12px; background: #1e293b; color: white; border: 1px solid #475569; border-radius: 8px; margin-bottom: 15px; cursor: pointer; outline: none; }
        .mapel-select:focus { border-color: var(--accent); }

        .rpm-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        .rpm-item { padding: 12px 15px; background: rgba(255,255,255,0.03); margin-bottom: 8px; border-radius: 8px; cursor: pointer; font-size: 13px; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid transparent; }
        .rpm-item:hover { background: rgba(255,255,255,0.08); }
        .rpm-item.active { background: var(--primary); border-left-color: var(--accent); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        
        .btn-new { width: 100%; padding: 12px; background: var(--accent); color: #0f172a; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; margin-bottom: 20px; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .btn-new:hover { background: #7dd3fc; transform: translateY(-1px); }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 40px; overflow-y: auto; scroll-behavior: smooth; }
        .container { max-width: 900px; margin: auto; background: var(--card-bg); padding: 50px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        
        .header-doc { text-align: center; margin-bottom: 40px; border-bottom: 2px solid var(--bg-main); padding-bottom: 20px; }
        h1 { margin: 0; font-size: 24px; color: var(--primary-dark); font-weight: 800; }
        .badge { display: inline-block; background: #e0f2fe; color: var(--primary); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; margin-top: 10px; letter-spacing: 0.5px; }

        h2 { font-size: 13px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-light); border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-top: 40px; margin-bottom: 20px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        
        .grid-form { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .span-3 { grid-column: span 3; }
        .span-2 { grid-column: span 2; }
        
        label { display: block; font-size: 11px; font-weight: 700; color: var(--text-light); margin-bottom: 8px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: #f8fafc; color: var(--text-main); transition: 0.2s; box-sizing: border-box; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        input[readonly] { background: #e2e8f0; color: #64748b; cursor: not-allowed; }

        /* Pertemuan Card */
        .pertemuan-card { border: 1px solid var(--border); background: #fff; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px dashed var(--border); padding-bottom: 15px; }
        .card-head strong { color: var(--primary); font-size: 15px; }
        
        .step-box { margin-top: 15px; }
        .step-label { font-size: 11px; font-weight: 800; color: var(--primary-dark); margin-bottom: 5px; display: block; }
        .step-box textarea { border-left: 4px solid var(--border); }
        .step-box:nth-child(2) textarea { border-left-color: #10b981; } 
        .step-box:nth-child(3) textarea { border-left-color: #f59e0b; } 
        .step-box:nth-child(4) textarea { border-left-color: #3b82f6; } 

        /* Buttons */
        .btn-action { padding: 6px 12px; font-size: 11px; border-radius: 6px; cursor: pointer; border: 1px solid transparent; font-weight: 600; }
        .btn-ghost { background: transparent; color: var(--text-light); border-color: var(--border); }
        .btn-ghost:hover { border-color: var(--primary); color: var(--primary); }
        .btn-danger { color: var(--danger); background: #fef2f2; border-color: #fecaca; }
        .btn-add { width: 100%; padding: 15px; border: 2px dashed var(--border); background: #f8fafc; color: var(--text-light); font-weight: 700; cursor: pointer; border-radius: 12px; transition: 0.2s; }
        .btn-add:hover { border-color: var(--primary); color: var(--primary); background: #eff6ff; }
        
        .footer-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 40px; }
        .btn-big { padding: 15px; font-size: 14px; font-weight: 700; border: none; border-radius: 10px; cursor: pointer; color: white; display: flex; justify-content: center; align-items: center; gap: 10px; transition: 0.2s; }
        .btn-big:hover { transform: translateY(-2px); shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-word { background: #2b579a; } 
        .btn-pdf { background: #be123c; } 

        /* Modal */
        #tpModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(15, 23, 42, 0.8); z-index:2000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:30px; border-radius:16px; max-width:550px; width:90%; max-height:80vh; overflow-y:auto; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .tp-item { padding: 12px; border-bottom: 1px solid var(--border); display: flex; gap: 12px; cursor: pointer; }
        .tp-item:hover { background: #f1f5f9; }

        .save-toast { position: fixed; bottom: 30px; right: 30px; background: var(--success); color: white; padding: 12px 25px; border-radius: 50px; font-weight: 600; font-size: 13px; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3); display: none; z-index: 3000; }
        
        /* 8 Dimensi Grid */
        .profil-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .p-item { background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid var(--border); transition: 0.2s; }
        .p-item:hover { border-color: var(--primary); background: #fff; }
        .p-hidden { display: none; margin-top: 10px; border-top: 1px solid #e2e8f0; padding-top: 10px; }
        .p-hidden textarea { font-size: 12px; padding: 8px; height: 60px; }

        .undo-redo { display: flex; gap: 5px; margin-bottom: 15px; }
        .btn-hist { flex: 1; padding: 6px; background: #334155; border: 1px solid #475569; color: #cbd5e1; cursor: pointer; border-radius: 4px; font-size: 11px; }
        .btn-hist:hover:not(:disabled) { background: #475569; color: white; }
        .btn-hist:disabled { opacity: 0.3; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="save-toast" id="saveNotif">Perubahan Tersimpan âœ“</div>

<div id="tpModal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:var(--primary-dark)">Pilih Tujuan Pembelajaran</h3>
        <div id="tpChoiceContainer" style="margin: 20px 0;"></div>
        <div style="text-align: right; gap: 10px; display: flex; justify-content: flex-end;">
            <button class="btn-action btn-ghost" onclick="document.getElementById('tpModal').style.display='none'">Batal</button>
            <button class="btn-action" style="background:var(--primary); color:white;" onclick="confirmImportTP()">Impor Data</button>
        </div>
    </div>
</div>

<div class="wrapper">
    <div class="sidebar">
        <div class="brand-box">
            <div class="brand-title">SiPandu RPM</div>
            <span class="brand-sub">DEEP LEARNING EDITION v2</span>
        </div>

        <div class="undo-redo">
            <button class="btn-hist" id="btnUndo" onclick="undo()" title="Undo">â†¶ Undo</button>
            <button class="btn-hist" id="btnRedo" onclick="redo()" title="Redo">â†· Redo</button>
        </div>

        <label style="color:#94a3b8; margin-bottom:5px;">MATA PELAJARAN:</label>
        <select class="mapel-select" id="sidebarMapel" onchange="filterByMapel()">
            <option value="Matematika">Matematika</option>
            <option value="Bahasa Indonesia">Bahasa Indonesia</option>
            <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
            <option value="IPAS">IPAS</option>
            <option value="PJOK">PJOK</option>
            <option value="Seni Budaya">Seni Budaya</option>
            <option value="Bahasa Inggris">Bahasa Inggris</option>
            <option value="PABP">Pendidikan Agama</option>
            <option value="Mulok">Mulok</option>
        </select>

        <button class="btn-new" onclick="createNewRPM()">+ BUAT BAB BARU</button>
        
        <div style="font-size: 10px; text-transform:uppercase; color:#64748b; margin: 15px 0 5px 0; font-weight:bold;">Daftar Rencana</div>
        <ul class="rpm-list" id="rpmList"></ul>
    </div>

    <div class="main-content">
        <div id="emptyState" style="text-align:center; padding-top:150px; opacity:0.5;">
            <div style="font-size: 50px; margin-bottom: 20px;">ðŸ“‚</div>
            <h3>Pilih Bab di Sidebar atau Buat Baru</h3>
        </div>

        <div class="container" id="formContainer" style="display:none;">
            <div class="header-doc">
                <h1>MODUL AJAR & RPM</h1>
                <span class="badge" id="modeBadge">DEEP LEARNING FRAMEWORK</span>
            </div>

            <form id="rpmForm" oninput="handleInput()">
                <div style="background:#f0f9ff; padding:10px 15px; border-radius:8px; border:1px solid #bae6fd; margin-bottom:25px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:12px; font-weight:bold; color:#0369a1;">MODE LANGKAH PEMBELAJARAN:</span>
                    <select id="pedagogyMode" onchange="changePedagogyMode()" style="width:auto; padding:6px; font-size:12px; background:white;">
                        <option value="Standar">Standar (Pendahuluan - Inti - Penutup)</option>
                        <option value="3M">3M (Mindful - Meaningful - Joyful)</option>
                    </select>
                </div>

                <h2>I. IDENTITAS MODUL (LENGKAP)</h2>
                <div class="grid-form">
                    <div class="span-3"><label>Satuan Pendidikan</label><input type="text" id="sekolah"></div>
                    <div class="span-2"><label>Judul Bab / Materi</label><input type="text" id="bab" oninput="updateSidebarLabel(this.value)"></div>
                    <div><label>Mapel (Otomatis)</label><input type="text" id="mapel" readonly></div>
                    
                    <div><label>Fase / Kelas</label>
                        <div style="display:flex; gap:5px;">
                            <select id="fase" style="width:40%"><option>A</option><option>B</option><option>C</option></select>
                            <select id="kelas" style="width:60%"><option>I</option><option>II</option><option>III</option><option>IV</option><option>V</option><option>VI</option></select>
                        </div>
                    </div>
                    <div><label>Semester</label><select id="semester"><option>1 (Ganjil)</option><option>2 (Genap)</option></select></div>
                    <div><label>Tahun Ajaran</label><input type="text" id="tahun" placeholder="2024/2025"></div>
                    
                    <div><label>Alokasi Waktu</label><input type="text" id="alokasi" placeholder="2 x 35 Menit"></div>
                    <div><label>Model Pembelajaran</label><input type="text" id="model_ajar" placeholder="PBL / PjBL / Tatap Muka"></div>
                    <div><label>Target Siswa</label><input type="text" id="target_siswa" placeholder="Reguler"></div>

                    <div class="span-3"><label>Sarana & Prasarana (Media)</label><textarea id="sarpras" placeholder="Laptop, LCD, Kertas Karton, Video Youtube..." style="height:50px;"></textarea></div>
                </div>

                <h2>II. KOMPONEN INTI</h2>
                <div style="position:relative; margin-bottom:20px;">
                    <label>Tujuan Pembelajaran (TP)</label>
                    <div style="position:absolute; right:0; top:0;">
                        <button type="button" class="btn-action btn-ghost" onclick="importDataDariAdmn()">ðŸ“¥ Impor dari ADMN</button>
                    </div>
                    <textarea id="tp" placeholder="Peserta didik mampu..." style="height:100px;"></textarea>
                </div>
                <div>
                    <label>Indikator Ketercapaian (IKTP)</label>
                    <textarea id="iktp" placeholder="1. ..." style="height:80px;"></textarea>
                </div>

                <h2>III. 8 DIMENSI PROFIL LULUSAN</h2>
                <div class="profil-grid" id="profilListContainer"></div>

                <h2>IV. PEMANTIK & MAKNA</h2>
                <div class="grid-form">
                    <div class="span-3"><label>Pertanyaan Pemantik</label><textarea id="pemantik" placeholder="Pertanyaan untuk memancing rasa ingin tahu..."></textarea></div>
                    <div class="span-3"><label>Pemahaman Bermakna</label><textarea id="bermakna" placeholder="Manfaat materi ini dalam kehidupan nyata..."></textarea></div>
                </div>

                <h2>V. LANGKAH PEMBELAJARAN</h2>
                <div id="pertemuanContainer"></div>
                <button type="button" class="btn-add" onclick="addPertemuan()">+ TAMBAH PERTEMUAN BERIKUTNYA</button>

                <h2>VI. ASESMEN</h2>
                <div class="grid-form">
                    <div class="span-3"><label>Strategi Diferensiasi (Opsional)</label><textarea id="diff_umum" placeholder="Konten, Proses, atau Produk..."></textarea></div>
                    <div><label>Asesmen Awal</label><textarea id="as_awal"></textarea></div>
                    <div><label>Asesmen Proses</label><textarea id="as_proses"></textarea></div>
                    <div><label>Asesmen Akhir</label><textarea id="as_akhir"></textarea></div>
                </div>

                <h2>VII. REFLEKSI & LAMPIRAN (DEEP LEARNING)</h2>
                <div class="grid-form">
                    <div class="span-3">
                        <label>Refleksi Guru & Peserta Didik (Mindful)</label>
                        <textarea id="refleksi" placeholder="Pertanyaan pemantik refleksi: Apa hal baru yang dipelajari? Apa tantangan yang dihadapi?"></textarea>
                    </div>
                    <div class="span-2">
                        <label>Glosarium (Kata Kunci)</label>
                        <textarea id="glosarium" placeholder="Daftar istilah penting..."></textarea>
                    </div>
                    <div>
                        <label>Daftar Pustaka</label>
                        <textarea id="pustaka" placeholder="Sumber belajar..."></textarea>
                    </div>
                </div>

                <div class="grid-form" style="margin-top:40px;">
                    <div class="span-2"><label>Guru Penyusun</label><input type="text" id="guru"></div>
                    <div><label>Kepala Sekolah</label><input type="text" id="ks"></div>
                </div>

                <div class="footer-actions">
                    <button type="button" class="btn-big btn-word" onclick="downloadDoc()">ðŸ“„ DOWNLOAD WORD</button>
                    <button type="button" class="btn-big btn-pdf" onclick="downloadPDF()">ðŸ“• CETAK PDF RESMI</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // === KONFIGURASI ===
    let db = JSON.parse(localStorage.getItem('rpm_db_deeplearning_v2')) || []; // Updated Key
    let currentId = null;
    let historyStack = [];
    let redoStack = [];
    let typingTimer;
    let tempTpList = [];

    const PEDAGOGY_LABELS = {
        "Standar": { m1: "PENDAHULUAN (Apersepsi)", m2: "KEGIATAN INTI", m3: "PENUTUP (Refleksi)" },
        "3M": { m1: "MINDFUL (Kesadaran)", m2: "MEANINGFUL (Pemahaman)", m3: "JOYFUL (Perayaan)" }
    };
    let currentMode = "Standar";

    const dimensiData = [
        { label: "Keimanan & Ketakwaan", desc: "Berdoa, nilai spiritual..." },
        { label: "Kewargaan", desc: "Cinta tanah air, peduli sosial..." },
        { label: "Penalaran Kritis", desc: "Analisis masalah, reflektif..." },
        { label: "Kreativitas", desc: "Inovasi, karya orisinal..." },
        { label: "Kolaborasi", desc: "Kerja kelompok, diskusi..." },
        { label: "Kemandirian", desc: "Tanggung jawab, inisiatif..." },
        { label: "Kesehatan", desc: "Fisik prima, well-being..." },
        { label: "Komunikasi", desc: "Presentasi, diskusi lisan..." }
    ];

    window.onload = () => {
        initProfilGrid();
        filterByMapel();
        updateHistoryButtons();
    };

    // === CORE LOGIC ===
    function handleInput() {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            saveState(); 
            saveCurrentData(false);
        }, 800);
    }

    function saveState() {
        if (historyStack.length > 0 && historyStack[historyStack.length - 1] === JSON.stringify(db)) return; 
        historyStack.push(JSON.stringify(db));
        if (historyStack.length > 20) historyStack.shift();
        redoStack = [];
        updateHistoryButtons();
    }

    function undo() {
        if (historyStack.length > 0) {
            redoStack.push(JSON.stringify(db));
            db = JSON.parse(historyStack.pop());
            syncAndReload();
        }
    }

    function redo() {
        if (redoStack.length > 0) {
            historyStack.push(JSON.stringify(db));
            db = JSON.parse(redoStack.pop());
            syncAndReload();
        }
    }

    function syncAndReload() {
        localStorage.setItem('rpm_db_deeplearning_v2', JSON.stringify(db));
        if (currentId) loadRPM(currentId);
        renderSidebar();
        updateHistoryButtons();
    }

    function updateHistoryButtons() {
        document.getElementById('btnUndo').disabled = historyStack.length === 0;
        document.getElementById('btnRedo').disabled = redoStack.length === 0;
    }

    function saveCurrentData() {
        if (!currentId) return;
        const index = db.findIndex(x => x.id === currentId);
        if (index === -1) return;

        // UPDATE: Fields lengkap untuk administrasi
        const fields = [
            'sekolah', 'bab', 'mapel', 'fase', 'kelas', 'semester', 'tahun', 
            'alokasi', 'model_ajar', 'target_siswa', 'sarpras', 
            'tp', 'iktp', 'pemantik', 'bermakna', 
            'diff_umum', 'as_awal', 'as_proses', 'as_akhir', 
            'refleksi', 'glosarium', 'pustaka', 'guru', 'ks'
        ];
        
        fields.forEach(f => { if(document.getElementById(f)) db[index][f] = document.getElementById(f).value; });
        
        db[index].pedagogyMode = document.getElementById('pedagogyMode').value;

        // Save 8 Dimensi
        db[index].profils = {};
        dimensiData.forEach((_, i) => { 
            if(document.getElementById(`chk_${i}`).checked) 
                db[index].profils[i] = { text: document.getElementById(`txt_${i}`).value }; 
        });

        // Save Pertemuan
        let pData = [];
        document.querySelectorAll('.pertemuan-card').forEach(c => {
            pData.push({ 
                m1: c.querySelector('.p_m1').value, 
                m2: c.querySelector('.p_m2').value, 
                m3: c.querySelector('.p_m3').value,
                tanggal: c.querySelector('.p_tanggal').value,
                jp: c.querySelector('.p_jp').value
            });
        });
        db[index].pertemuan = pData;
        
        localStorage.setItem('rpm_db_deeplearning_v2', JSON.stringify(db));
        showNotif();
    }

    // === UI RENDERING ===
    function initProfilGrid() {
        const container = document.getElementById('profilListContainer');
        container.innerHTML = dimensiData.map((d, i) => `
            <div class="p-item">
                <label style="cursor:pointer; display:flex; align-items:center; gap:8px; font-size:12px;">
                    <input type="checkbox" id="chk_${i}" onchange="toggleDimensi(${i})"> 
                    <span style="font-weight:700; color:#334155;">${d.label}</span>
                </label>
                <div class="p-hidden" id="inp_${i}">
                    <textarea id="txt_${i}" placeholder="${d.desc}"></textarea>
                </div>
            </div>
        `).join('');
    }

    function toggleDimensi(i) {
        const chk = document.getElementById(`chk_${i}`);
        document.getElementById(`inp_${i}`).style.display = chk.checked ? 'block' : 'none';
        saveCurrentData();
    }

    function changePedagogyMode() {
        currentMode = document.getElementById('pedagogyMode').value;
        const labels = PEDAGOGY_LABELS[currentMode];
        document.querySelectorAll('.pertemuan-card').forEach(card => {
            card.querySelector('.lbl-m1').innerText = labels.m1;
            card.querySelector('.lbl-m2').innerText = labels.m2;
            card.querySelector('.lbl-m3').innerText = labels.m3;
        });
        saveCurrentData();
    }

    function renderSidebar() {
        const selectedMapel = document.getElementById('sidebarMapel').value;
        const list = document.getElementById('rpmList');
        list.innerHTML = '';
        const filtered = db.filter(x => x.mapel === selectedMapel);
        filtered.forEach(item => {
            const li = document.createElement('li');
            li.className = `rpm-item ${currentId === item.id ? 'active' : ''}`;
            li.onclick = () => loadRPM(item.id);
            li.innerHTML = `<span>${item.bab || 'Bab Baru'}</span><span onclick="event.stopPropagation(); deleteRPM('${item.id}')" style="color:#f87171; font-weight:bold;">Ã—</span>`;
            list.appendChild(li);
        });
    }

    function createNewRPM() {
        saveState();
        const selectedMapel = document.getElementById('sidebarMapel').value;
        const newId = 'id_' + Date.now();
        db.push({ 
            id: newId, mapel: selectedMapel, bab: 'Bab Baru', 
            pedagogyMode: 'Standar',
            pertemuan: [{m1:'', m2:'', m3:'', tanggal:'', jp:''}], 
            profils: {} 
        });
        syncAndReload();
        loadRPM(newId);
    }

    function loadRPM(id) {
        currentId = id;
        const data = db.find(x => x.id === id);
        if (!data) return;

        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('formContainer').style.display = 'block';
        document.getElementById('mapel').value = data.mapel || '';
        
        // Load Fields Expanded
        const fields = [
            'sekolah', 'bab', 'fase', 'kelas', 'semester', 'tahun', 
            'alokasi', 'model_ajar', 'target_siswa', 'sarpras', 
            'tp', 'iktp', 'pemantik', 'bermakna', 
            'diff_umum', 'as_awal', 'as_proses', 'as_akhir', 
            'refleksi', 'glosarium', 'pustaka', 'guru', 'ks'
        ];
        fields.forEach(f => { if(document.getElementById(f)) document.getElementById(f).value = data[f] || ''; });

        currentMode = data.pedagogyMode || 'Standar';
        document.getElementById('pedagogyMode').value = currentMode;

        // Load 8 Dimensi
        dimensiData.forEach((_, i) => {
            const chk = document.getElementById(`chk_${i}`);
            const div = document.getElementById(`inp_${i}`);
            const saved = data.profils && data.profils[i];
            chk.checked = !!saved; 
            div.style.display = saved ? 'block' : 'none'; 
            document.getElementById(`txt_${i}`).value = saved ? saved.text : '';
        });

        const container = document.getElementById('pertemuanContainer');
        container.innerHTML = '';
        (data.pertemuan || []).forEach((p, idx) => {
            renderPertemuan(idx + 1, p.m1, p.m2, p.m3, p.tanggal, p.jp);
        });

        renderSidebar();
    }

    function renderPertemuan(num, m1='', m2='', m3='', tgl='', jp='') {
        const labels = PEDAGOGY_LABELS[currentMode];
        const div = document.createElement('div');
        div.className = 'pertemuan-card';
        div.innerHTML = `
            <div class="card-head">
                <strong>PERTEMUAN ${num}</strong>
                <div style="display:flex; gap:10px;">
                    <input type="text" class="p_tanggal" placeholder="Hari/Tanggal" value="${tgl}" style="width:120px;">
                    <input type="text" class="p_jp" placeholder="JP" value="${jp}" style="width:60px; text-align:center;">
                    <button type="button" class="btn-action btn-danger" onclick="deletePertemuan(${num-1})">Hapus</button>
                </div>
            </div>
            <div class="step-box">
                <span class="step-label lbl-m1">${labels.m1}</span>
                <textarea class="p_m1" placeholder="Kegiatan awal...">${m1}</textarea>
            </div>
            <div class="step-box">
                <span class="step-label lbl-m2">${labels.m2}</span>
                <textarea class="p_m2" style="height:80px;" placeholder="Kegiatan inti...">${m2}</textarea>
            </div>
            <div class="step-box">
                <span class="step-label lbl-m3">${labels.m3}</span>
                <textarea class="p_m3" placeholder="Kegiatan penutup...">${m3}</textarea>
            </div>
        `;
        document.getElementById('pertemuanContainer').appendChild(div);
    }

    function addPertemuan() {
        saveState();
        renderPertemuan(document.querySelectorAll('.pertemuan-card').length + 1);
        saveCurrentData();
    }

    function deletePertemuan(index) {
        if(!confirm('Hapus pertemuan ini?')) return;
        saveState();
        const activeData = db.find(x => x.id === currentId);
        if(activeData && activeData.pertemuan) {
            activeData.pertemuan.splice(index, 1);
            syncAndReload();
            loadRPM(currentId);
        }
    }

    function deleteRPM(id) {
        if(confirm('Hapus seluruh bab ini?')) {
            saveState(); 
            db = db.filter(x => x.id !== id); 
            syncAndReload();
            if(currentId === id) { 
                currentId = null; 
                document.getElementById('formContainer').style.display = 'none'; 
                document.getElementById('emptyState').style.display = 'block'; 
            }
        }
    }

    // === ADMN INTEGRATION ===
    function importDataDariAdmn() {
        const dataAdmnRaw = localStorage.getItem('sipandu_v1_4');
        if (!dataAdmnRaw) { alert("Data SiPandu ADMN tidak ditemukan."); return; }
        const dataAdmn = JSON.parse(dataAdmnRaw);
        const mapelSekarang = document.getElementById('sidebarMapel').value;
        const subjek = dataAdmn.subjects[mapelSekarang];
        if (!subjek || !subjek.tpList || subjek.tpList.length === 0) { alert("Tidak ada data TP untuk " + mapelSekarang); return; }
        
        tempTpList = subjek.tpList;
        document.getElementById('tpChoiceContainer').innerHTML = tempTpList.map((tp, i) => `
            <div class="tp-item">
                <input type="checkbox" class="tp-check" value="${i}">
                <span style="font-size:13px;">${tp.text}</span>
            </div>
        `).join('');
        document.getElementById('tpModal').style.display = 'flex';
        
        if(!document.getElementById('sekolah').value) document.getElementById('sekolah').value = dataAdmn.common.sekolah;
        if(!document.getElementById('guru').value) document.getElementById('guru').value = dataAdmn.common.guru;
        if(!document.getElementById('ks').value) document.getElementById('ks').value = dataAdmn.common.ks;
    }

    function confirmImportTP() {
        const checked = document.querySelectorAll('.tp-check:checked');
        if (checked.length === 0) return;
        saveState();
        let selectedTexts = [];
        checked.forEach(c => selectedTexts.push(tempTpList[c.value].text));
        const formatted = selectedTexts.map(t => `â€¢ ${t}`).join('\n');
        const currentVal = document.getElementById('tp').value;
        document.getElementById('tp').value = currentVal ? (currentVal + "\n" + formatted) : formatted;
        document.getElementById('tpModal').style.display = 'none';
        saveCurrentData();
    }

    // === EXPORT DOC ===
    function downloadDoc() {
        const data = db.find(x => x.id === currentId);
        if(!data) return;
        const labels = PEDAGOGY_LABELS[data.pedagogyMode || 'Standar'];
        
        let profilHtml = "";
        Object.keys(data.profils || {}).forEach(k => { 
            profilHtml += `<li><b>${dimensiData[k].label}:</b> ${data.profils[k].text}</li>`; 
        });
        
        let pertemuanHtml = "";
        (data.pertemuan || []).forEach((p, i) => {
            pertemuanHtml += `
                <tr bgcolor="#f1f5f9"><td colspan="2" style="border:1px solid #000; padding:5px;"><b>PERTEMUAN ${i+1} (${p.tanggal || '-'} | ${p.jp || '-'})</b></td></tr>
                <tr><td width="150" style="border:1px solid #000; padding:5px;">${labels.m1}</td><td style="border:1px solid #000; padding:5px;">${p.m1 || '-'}</td></tr>
                <tr><td style="border:1px solid #000; padding:5px;">${labels.m2}</td><td style="border:1px solid #000; padding:5px;">${p.m2 || '-'}</td></tr>
                <tr><td style="border:1px solid #000; padding:5px;">${labels.m3}</td><td style="border:1px solid #000; padding:5px;">${p.m3 || '-'}</td></tr>`;
        });

        const html = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'>
        <head><meta charset='utf-8'><style>body{font-family:'Times New Roman'; font-size:11pt} table{width:100%; border-collapse:collapse} td{vertical-align:top}</style></head>
        <body>
            <h2 align="center">MODUL AJAR KURIKULUM MERDEKA</h2>
            <table style="border:none">
                <tr><td width="160">Satuan Pendidikan</td><td>: ${data.sekolah}</td></tr>
                <tr><td>Mata Pelajaran</td><td>: ${data.mapel}</td></tr>
                <tr><td>Bab / Topik</td><td>: ${data.bab}</td></tr>
                <tr><td>Kelas / Fase</td><td>: ${data.kelas} / ${data.fase}</td></tr>
                <tr><td>Semester / T.A</td><td>: ${data.semester || '-'} / ${data.tahun || '-'}</td></tr>
                <tr><td>Alokasi Waktu</td><td>: ${data.alokasi}</td></tr>
            </table>
            <hr>
            <h3>A. TUJUAN PEMBELAJARAN</h3>
            <p>${data.tp.replace(/\n/g, '<br>')}</p>
            <h3>B. SARPRAS & PROFIL LULUSAN</h3>
            <p><b>Sarpras:</b> ${data.sarpras || '-'}</p>
            <ul>${profilHtml}</ul>
            <h3>C. LANGKAH PEMBELAJARAN</h3>
            <table>${pertemuanHtml}</table>
            <h3>D. ASESMEN & REFLEKSI</h3>
            <table border="1">
                <tr><th>Awal</th><th>Proses</th><th>Akhir</th></tr>
                <tr><td>${data.as_awal}</td><td>${data.as_proses}</td><td>${data.as_akhir}</td></tr>
            </table>
            <p><b>Refleksi:</b> ${data.refleksi || '-'}</p>
            <br>
            <table border="0">
                <tr><td align="center">Mengetahui,<br>Kepala Sekolah<br><br><br><b>${data.ks}</b></td><td align="center">Guru Penyusun<br><br><br><br><b>${data.guru}</b></td></tr>
            </table>
        </body></html>`;
        
        const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Modul_${data.bab}.doc`;
        a.click();
    }

    // === PDF ENGINE (FIXED) ===
    function downloadPDF() {
        const data = db.find(x => x.id === currentId);
        if(!data) return;

        // Create Virtual Element for Print
        const element = document.createElement('div');
        element.style.padding = "40px";
        element.style.fontFamily = "'Times New Roman', serif";
        element.style.fontSize = "11pt";
        element.style.lineHeight = "1.4";
        element.style.color = "#000";

        // Profil List
        let profilList = "";
        Object.keys(data.profils || {}).forEach(k => {
             profilList += `<li><b>${dimensiData[k].label}:</b> ${data.profils[k].text}</li>`;
        });

        // Steps
        let langkahHTML = "";
        const labels = PEDAGOGY_LABELS[data.pedagogyMode || 'Standar'];
        (data.pertemuan || []).forEach((p, i) => {
            langkahHTML += `
            <div style="margin-bottom:15px; border:1px solid #000; padding:10px;">
                <div style="background:#eee; padding:5px; font-weight:bold; border-bottom:1px solid #000; margin-bottom:5px;">
                    Pertemuan Ke-${i+1} (${p.tanggal || '-'} | ${p.jp || '-'})
                </div>
                <p style="margin:5px 0;"><b>A. ${labels.m1}:</b><br>${(p.m1||'-').replace(/\n/g,'<br>')}</p>
                <p style="margin:5px 0;"><b>B. ${labels.m2}:</b><br>${(p.m2||'-').replace(/\n/g,'<br>')}</p>
                <p style="margin:5px 0;"><b>C. ${labels.m3}:</b><br>${(p.m3||'-').replace(/\n/g,'<br>')}</p>
            </div>`;
        });

        element.innerHTML = `
            <h3 style="text-align:center; text-transform:uppercase; margin-bottom:5px;">Modul Ajar Kurikulum Merdeka</h3>
            <p style="text-align:center; font-size:10pt; margin-top:0;">${data.sekolah} | T.A ${data.tahun || '-'}</p>
            <hr style="border:1px solid #000; margin-bottom:20px;">
            
            <table style="width:100%; border-collapse:collapse; margin-bottom:15px; font-size:11pt;">
                <tr><td width="160"><b>Mata Pelajaran</b></td><td>: ${data.mapel}</td></tr>
                <tr><td><b>Bab / Materi</b></td><td>: ${data.bab}</td></tr>
                <tr><td><b>Kelas / Fase</b></td><td>: ${data.kelas} / ${data.fase} (Sem. ${data.semester||'-'})</td></tr>
                <tr><td><b>Alokasi Waktu</b></td><td>: ${data.alokasi}</td></tr>
                <tr><td><b>Model / Target</b></td><td>: ${data.model_ajar || '-'} / ${data.target_siswa || '-'}</td></tr>
            </table>

            <h4 style="margin-bottom:5px; background:#e2e8f0; padding:5px;">A. TUJUAN PEMBELAJARAN</h4>
            <div style="margin-left:5px; margin-bottom:10px;">${data.tp.replace(/\n/g, '<br>')}</div>

            <h4 style="margin-bottom:5px; background:#e2e8f0; padding:5px;">B. PROFIL LULUSAN & SARPRAS</h4>
            <ul style="margin-top:5px; margin-bottom:10px; padding-left:20px;">${profilList}</ul>
            <p style="margin-bottom:10px;"><b>Media & Sarpras:</b> ${data.sarpras || '-'}</p>

            <h4 style="margin-bottom:5px; background:#e2e8f0; padding:5px;">C. LANGKAH PEMBELAJARAN</h4>
            ${langkahHTML}

            <h4 style="margin-bottom:5px; background:#e2e8f0; padding:5px;">D. ASESMEN & REFLEKSI</h4>
            <table border="1" style="width:100%; border-collapse:collapse; margin-bottom:10px;">
                <tr style="background:#eee;"><th>Awal</th><th>Proses</th><th>Akhir</th></tr>
                <tr>
                    <td style="padding:5px; vertical-align:top;">${data.as_awal||'-'}</td>
                    <td style="padding:5px; vertical-align:top;">${data.as_proses||'-'}</td>
                    <td style="padding:5px; vertical-align:top;">${data.as_akhir||'-'}</td>
                </tr>
            </table>
            <p><b>Refleksi:</b> ${data.refleksi || '-'}</p>

            <br><br>
            <table style="width:100%; text-align:center; margin-top:20px;">
                <tr>
                    <td>Mengetahui,<br>Kepala Sekolah<br><br><br><br><b><u>${data.ks || '.....................'}</u></b></td>
                    <td>Guru Mata Pelajaran<br><br><br><br><br><b><u>${data.guru || '.....................'}</u></b></td>
                </tr>
            </table>
        `;

        const opt = {
            margin: [15, 15, 15, 15],
            filename: `Modul_Ajar_${data.bab.replace(/\s+/g,'_')}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save();
    }

    function filterByMapel() {
        renderSidebar();
    }
    
    function updateSidebarLabel(val) {
        if(!currentId) return;
        const el = document.querySelector('.rpm-item.active span');
        if(el) el.innerText = val || 'Bab Baru';
        // Auto update db name view
        const index = db.findIndex(x => x.id === currentId);
        if(index !== -1) {
            db[index].bab = val;
            localStorage.setItem('rpm_db_deeplearning_v2', JSON.stringify(db));
        }
    }
    
    function showNotif() {
        const n = document.getElementById('saveNotif');
        n.style.display='block';
        setTimeout(()=>n.style.display='none', 1500);
    }
</script>

</body>
</html>
