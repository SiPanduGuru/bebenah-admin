<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiPandu Guru V.1.1 - Human Friendly Edition</title>
    <style>
        :root { 
            /* Palette: Soft & Professional */
            --primary: #1e293b;          
            --accent: #22c55e;           
            --sidebar: #0f172a;          
            --bg: #f1f5f9;               
            --white: #ffffff; 
            --text: #334155;             
            --danger: #ef4444;           
            --gold: #facc15;             
            --info: #0ea5e9;             
            --bloom-bg: #ecfeff;         
        }
        
        * { box-sizing: border-box; font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; }
        
        body { margin: 0; display: flex; background: var(--bg); color: var(--text); min-height: 100vh; font-size: 14px; }

        /* Sidebar */
        .sidebar { 
            width: 260px; 
            background: linear-gradient(180deg, var(--sidebar), #020617);
            color: white; 
            display: flex; 
            flex-direction: column; 
            position: fixed; 
            height: 100vh; 
            overflow-y: auto; 
            z-index: 100;
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
        }
        .sidebar-header { padding: 25px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-header h2 { margin: 0; font-size: 18px; color: var(--accent); letter-spacing: 1px; font-weight: 800; }
        .sidebar-header small { opacity: 0.6; font-size: 11px; display: block; margin-top: 5px; }

        .nav-menu { flex-grow: 1; padding: 15px 0; }
        .nav-item { 
            padding: 12px 20px; 
            cursor: pointer; 
            font-size: 13px; 
            border-left: 3px solid transparent; 
            transition: all 0.2s; 
            color: rgba(255,255,255,0.7); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { 
            background: rgba(34, 197, 94, 0.1); 
            border-left-color: var(--accent); 
            color: var(--accent); 
            font-weight: 600; 
        }

        .mapel-selector { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); }
        .mapel-selector label { font-size: 11px; text-transform: uppercase; color: #94a3b8; display: block; margin-bottom: 8px; font-weight: bold; }
        select { background: #334155; color: white; border: 1px solid #475569; padding: 10px; border-radius: 6px; width: 100%; cursor: pointer; outline: none; font-size: 13px; }

        /* Main Area */
        .main { margin-left: 260px; width: calc(100% - 260px); padding: 40px; }
        .page { display: none; max-width: 1100px; margin: auto; animation: fadeIn 0.3s ease-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Card */
        .card { 
            background: var(--white); 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
            margin-bottom: 25px; 
            border: 1px solid #e2e8f0; 
        }
        h1 { 
            font-size: 20px; 
            font-weight: 700; 
            color: var(--primary); 
            border-bottom: 2px solid #f1f5f9; 
            padding-bottom: 15px; 
            margin-bottom: 25px; 
        }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        label { font-size: 12px; font-weight: 600; color: #64748b; display: block; margin-bottom: 6px; }
        input, textarea, .page select { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid #cbd5e1; 
            border-radius: 8px; 
            font-size: 14px; 
            color: var(--text);
            background: #fff;
            transition: 0.2s;
        }
        input:focus, textarea:focus, .page select:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1); }

        .btn-action { 
            background: var(--accent); 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            transition: 0.2s; 
            font-size: 13px;
        }
        .btn-action:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-info { background: var(--info); }
        .btn-danger { background: var(--danger); }

        /* Table */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 20px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        th { background: #f8fafc; padding: 12px; color: #475569; font-size: 11px; text-transform: uppercase; font-weight: 700; border-bottom: 1px solid #e2e8f0; text-align: left; }
        td { border-bottom: 1px solid #e2e8f0; padding: 10px; font-size: 13px; vertical-align: top; }
        tr:last-child td { border-bottom: none; }
        
        /* Badges & Chips */
        .materi-chip { 
            display: inline-flex; align-items: center; gap: 5px; 
            padding: 4px 10px; margin: 2px; 
            background: #f1f5f9; border: 1px solid #e2e8f0; 
            border-radius: 20px; font-size: 12px; color: #475569; 
            cursor: pointer; user-select: none;
        }
        .materi-chip.active { background: #dcfce7; border-color: #86efac; color: #166534; }
        .materi-chip .close { font-size: 10px; width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(0,0,0,0.1); }
        
        .smt-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .smt-1 { background: #e0f2fe; color: #0369a1; }
        .smt-2 { background: #f0fdf4; color: #15803d; }

        /* PROMES Grid */
        .promes-scroll { overflow-x: auto; padding-bottom: 10px; }
        .week-cell { 
            cursor: pointer; width: 24px; height: 30px; 
            border: 1px solid #e2e8f0; 
            transition: 0.1s; background: #fff; 
        }
        /* Color Coding Promes */
        .cell-kbm { background-color: #22c55e !important; } /* Hijau */
        .cell-libur { background-color: #ef4444 !important; } /* Merah */
        .cell-ujian { background-color: #facc15 !important; } /* Kuning */
        .cell-uh { background-color: #3b82f6 !important; } /* Biru */

        .brush-toolbar { display: flex; gap: 10px; margin-bottom: 15px; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .brush-btn { 
            padding: 6px 12px; border: 2px solid transparent; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 6px;
        }
        .brush-btn.active { border-color: #000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        @media print {
            .sidebar, .no-print, .btn-action, .brush-toolbar { display: none !important; }
            .main { margin-left: 0; width: 100%; padding: 0; }
            .card { box-shadow: none; border: none; padding: 0; }
            .page { display: block !important; } /* Show all for print maybe? Or print specific */
            /* Usually users print exported word docs, but just in case */
        }
    </style>
</head>
<body>

<datalist id="elemenList"></datalist>

<div class="sidebar no-print">
    <div class="sidebar-header">
        <h2>SIPANDU GURU</h2>
        <small>V.1.1 - Human Friendly</small>
    </div>

    <div class="nav-menu">
        <div class="nav-item active" onclick="showPage('identitas')">ðŸ“˜ 1. Identitas</div>
        <div class="nav-item" onclick="showPage('cp_sec')">ðŸ“— 2. CP & Elemen</div>
        <div class="nav-item" onclick="showPage('tp_sec')">ðŸ“™ 3. TP (Tujuan)</div>
        <div class="nav-item" onclick="showPage('atp_sec')">ðŸ“• 4. ATP (Alur)</div>
        <div class="nav-item" onclick="showPage('prota_sec')">ðŸ“’ 5. PROTA</div>
        <div class="nav-item" onclick="showPage('promes_sec')">ðŸ““ 6. PROMES</div>
    </div>

    <div class="mapel-selector">
        <label>Mata Pelajaran:</label>
        <select id="mainMapel" onchange="switchSubject()">
            <option>Pendidikan Agama dan BP</option>
            <option>Pendidikan Pancasila</option>
            <option>Bahasa Indonesia</option>
            <option>Matematika</option>
            <option>Seni Budaya</option>
            <option>IPAS</option>
            <option>PJOK</option>
            <option>Bahasa Inggris</option>
            <option>Mulok Bahasa Jawa</option>
            <option value="custom">+ Tambah Mapel</option>
        </select>
    </div>
</div>

<div class="main">
    
    <div id="identitas" class="page active">
        <div class="card">
            <h1>DATA IDENTITAS & TANDA TANGAN</h1>
            <div class="grid-2">
                <div><label>Nama Sekolah</label><input type="text" id="sekolah" oninput="saveAll()"></div>
                <div><label>Tahun Pelajaran</label><input type="text" id="tapel" value="2025/2026" oninput="saveAll()"></div>
                <div><label>Fase</label><select id="fase" onchange="saveAll()"><option value="A">Fase A (Kelas 1-2)</option><option value="B" selected>Fase B (Kelas 3-4)</option><option value="C">Fase C (Kelas 5-6)</option></select></div>
                <div><label>Kelas</label><select id="kelas" onchange="saveAll()"><option>I</option><option>II</option><option>III</option><option selected>IV</option><option>V</option><option>VI</option></select></div>
                <div><label>Nama Guru</label><input type="text" id="guru" oninput="saveAll()"></div>
                <div><label>NIP Guru</label><input type="text" id="nip" oninput="saveAll()"></div>
                <div><label>Nama Kepala Sekolah</label><input type="text" id="ks" oninput="saveAll()"></div>
                <div><label>NIP Kepala Sekolah</label><input type="text" id="ks_nip" oninput="saveAll()"></div>
            </div>
            <div style="margin-top:20px;">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                    <input type="checkbox" id="showTtd" onchange="saveAll()" style="width:auto;"> Tampilkan Tanda Tangan di Hasil Ekspor
                </label>
            </div>
        </div>
    </div>

    <div id="cp_sec" class="page">
        <div class="card">
            <h1>CAPAIAN PEMBELAJARAN (CP)</h1>
            <p style="font-size:13px; color:#64748b; margin-bottom:20px;">Masukkan elemen CP dari dokumen regulasi. Ini akan jadi referensi saat menyusun TP.</p>
            <div id="elemenContainer"></div>
            <div style="display: flex; gap: 10px; margin-top:15px;">
                <button class="btn-action" onclick="addElemen()">+ Tambah Elemen</button>
                <button class="btn-action btn-info" onclick="generateTP()">âœ¨ Generate TP Otomatis</button>
            </div>
        </div>
    </div>

    <div id="tp_sec" class="page">
        <div class="card">
            <h1>TUJUAN PEMBELAJARAN (TP)</h1>
            <div id="tpExportArea">
                <div class="header-doc"></div>
                <table id="tpTable">
                    <thead><tr><th width="40">No</th><th width="200">Elemen</th><th>Deskripsi Tujuan Pembelajaran</th><th width="100">Semester</th><th class="no-print" width="50">Aksi</th></tr></thead>
                    <tbody id="tpBody"></tbody>
                </table>
                <div class="ttd-area"></div>
            </div>
            <div style="display: flex; gap: 10px; margin-top:20px;">
                <button class="btn-action" onclick="addTPRow()">+ Tambah Baris TP</button>
                <button class="btn-action btn-info" onclick="exportToWord('tpExportArea', 'DAFTAR_TP')">ðŸ’¾ Ekspor Word</button>
            </div>
        </div>
    </div>

    <div id="atp_sec" class="page">
        <div class="card">
            <h1>ALUR TUJUAN PEMBELAJARAN (ATP)</h1>
            <div class="no-print" style="margin-bottom:20px; padding:15px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px;">
                <label>Master Materi / Bab (Pisahkan dengan koma)</label>
                <textarea id="masterMateriInput" rows="2" onchange="updateMasterMateri(this.value)" placeholder="Contoh: Bilangan Cacah, Pecahan, Geometri..."></textarea>
                <small style="color:#94a3b8">Ketik materi di sini agar muncul sebagai pilihan cepat di tabel.</small>
            </div>
            <div id="atpExportArea">
                <div class="header-doc"></div>
                <table id="atpTable">
                    <thead><tr><th width="40">No</th><th>Elemen</th><th>Tujuan Pembelajaran</th><th>Materi / Lingkup Bahasan</th><th width="80">JP</th></tr></thead>
                    <tbody id="atpBody"></tbody>
                </table>
                <div class="ttd-area"></div>
            </div>
            <button class="btn-action btn-info" onclick="exportToWord('atpExportArea', 'ATP')">ðŸ’¾ Ekspor Word</button>
        </div>
    </div>

    <div id="prota_sec" class="page">
        <div class="card">
            <h1>PROGRAM TAHUNAN (PROTA)</h1>
            <p style="font-size:13px; color:#64748b;">Anda bisa mengedit JP dan Semester langsung di sini untuk penyesuaian.</p>
            <div id="protaExportArea">
                <div class="header-doc"></div>
                <table id="protaTable">
                    <thead><tr><th width="40">No</th><th>Tujuan Pembelajaran</th><th>Materi</th><th width="80">Smt</th><th width="80">JP</th></tr></thead>
                    <tbody id="protaBody"></tbody>
                </table>
                <div class="ttd-area"></div>
            </div>
            <button class="btn-action btn-info" onclick="exportToWord('protaExportArea', 'PROTA')">ðŸ’¾ Ekspor Word</button>
        </div>
    </div>

    <div id="promes_sec" class="page">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1>PROGRAM SEMESTER (PROMES)</h1>
                <button class="btn-action" style="background:var(--gold); color:#000;" onclick="toggleSemester()">
                    ðŸ”„ Pindah Semester <span id="currentSmtDisplay">1</span>
                </button>
            </div>

            <div class="brush-toolbar no-print">
                <span style="font-size:12px; font-weight:bold; color:#64748b; align-self:center;">PILIH KUAS:</span>
                <div class="brush-btn" id="btn-kbm" onclick="setBrush('kbm')" style="background:#dcfce7; color:#166534; border-color:#22c55e;">
                    ðŸŸ¢ KBM
                </div>
                <div class="brush-btn" id="btn-uh" onclick="setBrush('uh')" style="background:#dbeafe; color:#1e40af; border-color:#3b82f6;">
                    ðŸ”µ Asesmen
                </div>
                <div class="brush-btn" id="btn-ujian" onclick="setBrush('ujian')" style="background:#fef9c3; color:#854d0e; border-color:#facc15;">
                    ðŸŸ¡ STS/SAS
                </div>
                <div class="brush-btn" id="btn-libur" onclick="setBrush('libur')" style="background:#fee2e2; color:#991b1b; border-color:#ef4444;">
                    ðŸ”´ Libur
                </div>
                <div class="brush-btn" id="btn-hapus" onclick="setBrush(null)" style="background:#fff; border-color:#cbd5e1; color:#64748b;">
                    âšª Hapus
                </div>
            </div>

            <div id="promesExportArea">
                <div class="header-doc"></div>
                <div class="promes-scroll">
                    <table id="promesTable">
                        <thead id="promesHead"></thead>
                        <tbody id="promesBody"></tbody>
                    </table>
                </div>
                <div class="ttd-area"></div>
            </div>
            
            <div class="no-print" style="margin-top:10px; font-size:11px; color:#64748b;">
                *Klik kotak untuk mewarnai sesuai kuas yang dipilih.
            </div>
            
            <button class="btn-action btn-info" onclick="exportToWord('promesExportArea', 'PROMES')">ðŸ’¾ Ekspor Word</button>
        </div>
    </div>
</div>

<script>
    // State Management
    let state = {
        common: { sekolah: '', guru: '', nip: '', ks: '', ks_nip: '', fase: 'B', kelas: 'IV', tapel: '2025/2026', showTtd: false },
        subjects: {},
        currentSmt: 1
    };
    let currentMapel = "Pendidikan Agama dan BP";
    let currentBrush = 'kbm'; // Default brush

    // Bloom Taxanomy Helper
    const BLOOM_MAP = {
        'C1': ['mengenal', 'menyebutkan', 'mengingat', 'menghafal', 'membaca'],
        'C2': ['memahami', 'menjelaskan', 'mengidentifikasi', 'mengklasifikasikan'],
        'C3': ['menerapkan', 'menggunakan', 'mempraktikkan', 'mendemonstrasikan'],
        'C4': ['menganalisis', 'membandingkan', 'membedakan', 'menghubungkan'],
        'C5': ['mengevaluasi', 'menilai', 'menyimpulkan'],
        'C6': ['menciptakan', 'merancang', 'membuat', 'menyusun']
    };

    window.onload = () => {
        const saved = localStorage.getItem('sipandu_v1_6'); // New key for v1.1
        if (saved) state = JSON.parse(saved);
        loadIdentitas();
        switchSubject();
        setBrush('kbm'); // Init brush UI
    };

    // --- NAVIGATION & MAPEL ---
    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const nav = document.querySelector(`.nav-item[onclick="showPage('${id}')"]`);
        if(nav) nav.classList.add('active');
    }

    function switchSubject() {
        const sel = document.getElementById('mainMapel');
        if(sel.value === 'custom') {
            const newMapel = prompt("Nama Mata Pelajaran Baru:");
            if(newMapel) {
                const opt = document.createElement("option"); opt.text = newMapel; opt.selected = true;
                sel.add(opt, sel.options[sel.length-1]); currentMapel = newMapel;
            } else { sel.selectedIndex = 0; currentMapel = sel.value; }
        } else { currentMapel = sel.value; }

        if (!state.subjects[currentMapel]) {
            state.subjects[currentMapel] = { elemenList: [{name: '', cp: ''}], tpList: [], materiMaster: '' };
        }
        
        // Update Datalist for Elemen
        const dl = document.getElementById('elemenList'); dl.innerHTML = '';
        state.subjects[currentMapel].elemenList.forEach(e => {
            if(e.name) dl.innerHTML += `<option value="${e.name}">`;
        });

        document.getElementById('masterMateriInput').value = state.subjects[currentMapel].materiMaster || '';
        renderAll();
    }

    // --- DATA HANDLING ---
    function saveAll() {
        // Save Common
        ['sekolah','guru','nip','ks','ks_nip','fase','kelas','tapel'].forEach(id => {
            const el = document.getElementById(id);
            if(el) state.common[id] = el.value;
        });
        state.common.showTtd = document.getElementById('showTtd').checked;
        
        localStorage.setItem('sipandu_v1_6', JSON.stringify(state));
        renderAll(); // Re-render to update UI
    }

    function renderAll() {
        renderElemen();
        renderTP();
        renderATP();
        renderProta();
        renderPromes();
        updateDocsHeaderFooter();
    }

    // --- 2. CP & ELEMEN ---
    function renderElemen() {
        const container = document.getElementById('elemenContainer'); container.innerHTML = '';
        state.subjects[currentMapel].elemenList.forEach((el, i) => {
            container.innerHTML += `
            <div class="card" style="padding:20px; border-left:4px solid var(--accent)">
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <label>Elemen ${i+1}</label>
                    <button class="btn-action btn-danger" style="padding:4px 8px; font-size:10px" onclick="delElemen(${i})">Hapus</button>
                </div>
                <input value="${el.name}" placeholder="Contoh: Bilangan" onchange="updateElemen(${i}, 'name', this.value)" style="margin-bottom:10px; font-weight:bold;">
                <label>Capaian Pembelajaran (CP)</label>
                <textarea style="min-height:80px" onchange="updateElemen(${i}, 'cp', this.value)">${el.cp}</textarea>
            </div>`;
        });
    }
    function addElemen() { state.subjects[currentMapel].elemenList.push({name:'', cp:''}); saveAll(); }
    function delElemen(i) { if(confirm('Hapus elemen ini?')) { state.subjects[currentMapel].elemenList.splice(i,1); saveAll(); } }
    function updateElemen(i, f, v) { state.subjects[currentMapel].elemenList[i][f] = v; saveAll(); }

    // --- 3. TP (Hybrid Input) ---
    function renderTP() {
        const body = document.getElementById('tpBody'); body.innerHTML = '';
        state.subjects[currentMapel].tpList.forEach((tp, i) => {
            const smtClass = tp.smt == 1 ? 'smt-1' : 'smt-2';
            body.innerHTML += `
            <tr>
                <td>${i+1}</td>
                <td><input list="elemenList" value="${tp.elemen}" onchange="updateTP(${i}, 'elemen', this.value)" placeholder="Pilih/Ketik..."></td>
                <td>
                    <textarea onchange="updateTP(${i}, 'text', this.value)" style="min-height:60px">${tp.text}</textarea>
                </td>
                <td style="text-align:center">
                    <select class="smt-badge ${smtClass}" onchange="updateTP(${i}, 'smt', this.value)" style="width:auto; padding:5px;">
                        <option value="1" ${tp.smt==1?'selected':''}>Smt 1</option>
                        <option value="2" ${tp.smt==2?'selected':''}>Smt 2</option>
                    </select>
                </td>
                <td class="no-print" style="text-align:center">
                    <button onclick="delTP(${i})" style="color:var(--danger); background:none; border:none; cursor:pointer; font-weight:bold;">Ã—</button>
                </td>
            </tr>`;
        });
    }
    function addTPRow() { state.subjects[currentMapel].tpList.push({elemen:'', text:'', smt:1, jp:4, selectedMateri:[], checklists:{1:[], 2:[]} }); saveAll(); }
    function updateTP(i, f, v) { state.subjects[currentMapel].tpList[i][f] = v; saveAll(); }
    function delTP(i) { if(confirm('Hapus TP?')) { state.subjects[currentMapel].tpList.splice(i,1); saveAll(); } }
    
    function generateTP() {
        const sub = state.subjects[currentMapel];
        let count = 0;
        sub.elemenList.forEach(el => {
            if(!el.cp) return;
            el.cp.split('.').forEach(s => {
                const txt = s.trim();
                if(txt.length > 10) {
                    sub.tpList.push({elemen: el.name, text: txt+'.', smt:1, jp:4, selectedMateri:[], checklists:{1:[], 2:[]} });
                    count++;
                }
            });
        });
        saveAll(); alert(count + " TP berhasil dibuat!"); showPage('tp_sec');
    }

    // --- 4. ATP (Living Document) ---
    function renderATP() {
        const body = document.getElementById('atpBody'); body.innerHTML = '';
        const masterMat = (state.subjects[currentMapel].materiMaster || '').split(',').map(s=>s.trim()).filter(s=>s);
        
        state.subjects[currentMapel].tpList.forEach((tp, i) => {
            // Materi Chips
            let chipsHtml = '';
            (tp.selectedMateri || []).forEach(m => {
                chipsHtml += `<span class="materi-chip active">${m} <span class="close" onclick="removeMateri(${i}, '${m}')">Ã—</span></span>`;
            });
            // Suggestions
            let suggestHtml = '';
            masterMat.filter(m => !(tp.selectedMateri||[]).includes(m)).forEach(m => {
                suggestHtml += `<span class="materi-chip" onclick="addMateri(${i}, '${m}')">+ ${m}</span>`;
            });

            body.innerHTML += `
            <tr>
                <td>${i+1}</td>
                <td>${tp.elemen}</td>
                <td>${tp.text}</td>
                <td>
                    <div class="no-print" style="margin-bottom:5px;">${chipsHtml}</div>
                    <div class="no-print" style="color:#94a3b8; font-size:11px;">Pilih: ${suggestHtml}</div>
                    <div style="display:none;" class="print-only">${(tp.selectedMateri||[]).join(', ')}</div>
                </td>
                <td><input type="number" value="${tp.jp}" onchange="updateTP(${i}, 'jp', this.value)" style="text-align:center; font-weight:bold;"></td>
            </tr>`;
        });
    }
    function updateMasterMateri(v) { state.subjects[currentMapel].materiMaster = v; saveAll(); }
    function addMateri(i, m) { 
        if(!state.subjects[currentMapel].tpList[i].selectedMateri) state.subjects[currentMapel].tpList[i].selectedMateri = [];
        state.subjects[currentMapel].tpList[i].selectedMateri.push(m); saveAll(); 
    }
    function removeMateri(i, m) {
        let arr = state.subjects[currentMapel].tpList[i].selectedMateri;
        state.subjects[currentMapel].tpList[i].selectedMateri = arr.filter(x => x !== m); saveAll();
    }

    // --- 5. PROTA (Editable) ---
    function renderProta() {
        const body = document.getElementById('protaTable').querySelector('tbody'); body.innerHTML = '';
        state.subjects[currentMapel].tpList.forEach((tp, i) => {
            const materi = (tp.selectedMateri || []).join(', ');
            body.innerHTML += `
            <tr>
                <td>${i+1}</td>
                <td>${tp.text}</td>
                <td>${materi}</td>
                <td>
                    <select onchange="updateTP(${i}, 'smt', this.value)" style="padding:5px">
                        <option value="1" ${tp.smt==1?'selected':''}>1</option>
                        <option value="2" ${tp.smt==2?'selected':''}>2</option>
                    </select>
                </td>
                <td>
                    <input type="number" value="${tp.jp}" onchange="updateTP(${i}, 'jp', this.value)" style="width:60px; text-align:center">
                </td>
            </tr>`;
        });
    }

    // --- 6. PROMES (Color Coding) ---
    function toggleSemester() {
        state.currentSmt = state.currentSmt === 1 ? 2 : 1;
        document.getElementById('currentSmtDisplay').innerText = state.currentSmt;
        renderPromes();
    }

    function setBrush(type) {
        currentBrush = type;
        document.querySelectorAll('.brush-btn').forEach(b => b.classList.remove('active'));
        if(type) document.getElementById(`btn-${type}`).classList.add('active');
        else document.getElementById(`btn-hapus`).classList.add('active');
    }

    function renderPromes() {
        const head = document.getElementById('promesHead');
        const body = document.getElementById('promesBody');
        const months = state.currentSmt == 1 ? ["Jul", "Agt", "Sep", "Okt", "Nov", "Des"] : ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun"];
        
        // Header
        let h1 = `<tr><th rowspan="2" style="width:30px">No</th><th rowspan="2" style="width:200px">TP & Materi</th><th rowspan="2" style="width:40px">JP</th>`;
        let h2 = `<tr>`;
        months.forEach(m => { h1 += `<th colspan="5" style="text-align:center">${m}</th>`; for(let k=1;k<=5;k++) h2+=`<th style="font-size:9px; text-align:center; color:#ccc">${k}</th>`; });
        head.innerHTML = h1 + "</tr>" + h2 + "</tr>";

        // Body
        body.innerHTML = '';
        state.subjects[currentMapel].tpList.filter(t => t.smt == state.currentSmt).forEach((tp, idx) => {
            // Fix index reference back to main list
            const realIdx = state.subjects[currentMapel].tpList.indexOf(tp);
            
            // Ensure Checklists
            if(!tp.checklists) tp.checklists = {1:[], 2:[]};
            if(!tp.checklists[state.currentSmt]) tp.checklists[state.currentSmt] = [];

            let cells = '';
            for(let w=0; w<30; w++) {
                const val = tp.checklists[state.currentSmt][w];
                let cls = '';
                if(val === 'kbm') cls = 'cell-kbm';
                else if(val === 'uh') cls = 'cell-uh';
                else if(val === 'ujian') cls = 'cell-ujian';
                else if(val === 'libur') cls = 'cell-libur';
                
                cells += `<td class="week-cell ${cls}" onclick="paintCell(${realIdx}, ${w})"></td>`;
            }
            body.innerHTML += `<tr>
                <td>${idx+1}</td>
                <td><div style="font-weight:bold; font-size:11px">${tp.elemen}</div>${tp.text}</td>
                <td style="text-align:center">${tp.jp}</td>
                ${cells}
            </tr>`;
        });
    }

    function paintCell(realIdx, week) {
        // Toggle Logic with Brush
        const tp = state.subjects[currentMapel].tpList[realIdx];
        const currentVal = tp.checklists[state.currentSmt][week];

        if (currentBrush === null) {
            tp.checklists[state.currentSmt][week] = null; // Hapus
        } else if (currentVal === currentBrush) {
            tp.checklists[state.currentSmt][week] = null; // Toggle off if same
        } else {
            tp.checklists[state.currentSmt][week] = currentBrush; // Paint
        }
        saveAll();
    }

    // --- UTILS & EXPORT ---
    function loadIdentitas() {
        ['sekolah','guru','nip','ks','ks_nip','fase','kelas','tapel'].forEach(id => { 
            const el = document.getElementById(id); if(el) el.value = state.common[id] || ''; 
        });
        document.getElementById('showTtd').checked = state.common.showTtd;
        document.getElementById('currentSmtDisplay').innerText = state.currentSmt;
    }

    function updateDocsHeaderFooter() {
        const c = state.common;
        const headerHTML = `
            <div style="text-align:center; font-family:'Times New Roman'; margin-bottom:20px; border-bottom:3px double #000; padding-bottom:10px;">
                <h3 style="margin:0; text-transform:uppercase">${c.sekolah}</h3>
                <div style="font-size:14px">Tahun Pelajaran ${c.tapel}</div>
            </div>
            <table style="width:100%; font-family:'Times New Roman'; font-size:12px; margin-bottom:15px; border:none;">
                <tr>
                    <td style="border:none; width:15%">Mata Pelajaran</td><td style="border:none">: ${currentMapel}</td>
                    <td style="border:none; width:15%">Kelas / Fase</td><td style="border:none">: ${c.kelas} / ${c.fase}</td>
                </tr>
            </table>`;
            
        const ttdHTML = state.common.showTtd ? `
            <div style="display:flex; justify-content:space-between; margin-top:40px; font-family:'Times New Roman'; font-size:12px; page-break-inside:avoid;">
                <div style="text-align:center">
                    Mengetahui,<br>Kepala Sekolah<br><br><br><br>
                    <b><u>${c.ks}</u></b><br>NIP. ${c.ks_nip}
                </div>
                <div style="text-align:center">
                    Guru Mata Pelajaran<br><br><br><br>
                    <b><u>${c.guru}</u></b><br>NIP. ${c.nip}
                </div>
            </div>` : '';

        document.querySelectorAll('.header-doc').forEach(el => el.innerHTML = headerHTML);
        document.querySelectorAll('.ttd-area').forEach(el => el.innerHTML = ttdHTML);
    }

    function exportToWord(elementId, filename) {
        const content = document.getElementById(elementId).innerHTML;
        // Simple Clean for Word
        const cleanContent = content.replace(/<button.*?>.*?<\/button>/g, "")
                                    .replace(/class="no-print"/g, 'style="display:none"')
                                    .replace(/placeholder=".*?"/g, "");
        
        const html = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'>
        <head><meta charset='utf-8'><style>
            body { font-family: 'Times New Roman', serif; font-size: 12pt; }
            table { width: 100%; border-collapse: collapse; }
            td, th { border: 1px solid black; padding: 5px; vertical-align: top; }
            .cell-kbm { background-color: #22c55e; } 
            .cell-libur { background-color: #ef4444; }
            .cell-ujian { background-color: #facc15; }
        </style></head>
        <body>${cleanContent}</body></html>`;
        
        const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${filename}_${currentMapel}.doc`;
        link.click();
    }
</script>
</body>
</html>
