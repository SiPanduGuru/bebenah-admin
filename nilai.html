<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiPandu Nilai - Rekapitulasi Cerdas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            /* THEME: Soft Slate (Professional & Calm) */
            --bg-main: #f1f5f9;
            --card-bg: #ffffff;
            --header-bg: #1e293b; /* Sidebar color from previous module */
            --text-main: #334155;
            --text-light: #64748b;
            --border: #cbd5e1;
            
            --primary: #2563eb;
            --accent: #0ea5e9;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Inter, sans-serif; }
        
        body { margin: 0; background: var(--bg-main); color: var(--text-main); font-size: 14px; padding: 30px; }
        .container { max-width: 1200px; margin: auto; }

        /* HEADER */
        .header-section { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; }
        .brand h1 { margin: 0; font-size: 24px; color: var(--header-bg); font-weight: 800; letter-spacing: -0.5px; }
        .brand p { margin: 5px 0 0 0; color: var(--text-light); font-size: 13px; }

        /* CARD STYLE */
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; }
        
        /* CONTROLS (Top Bar) */
        .controls { padding: 20px; background: #fff; border-bottom: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 20px; align-items: center; justify-content: space-between; }
        
        .control-group { display: flex; gap: 10px; align-items: center; }
        .control-group label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-light); }
        
        select, input[type="text"] { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; color: var(--text-main); }
        
        /* BUTTONS */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        
        /* DATA TABLE (The Excel Feel) */
        .table-wrapper { overflow-x: auto; max-height: 70vh; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        
        th { background: #f8fafc; padding: 12px; text-align: left; font-size: 12px; font-weight: 700; color: var(--text-main); border-bottom: 2px solid var(--border); border-right: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 10; white-space: nowrap; }
        
        td { border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; padding: 0; }
        td:first-child { background: #fff; position: sticky; left: 0; z-index: 5; border-right: 2px solid var(--border); }
        
        /* Input dalam tabel (Seamless) */
        td input { width: 100%; border: none; padding: 12px; background: transparent; font-size: 13px; outline: none; }
        td input:focus { background: #f0f9ff; box-shadow: inset 0 0 0 2px var(--accent); }
        td input[type="number"] { text-align: center; font-weight: 600; }
        
        /* Rata-rata Column */
        .col-avg { background: #f0fdf4; font-weight: bold; color: var(--success); text-align: center; }
        
        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 500px; max-width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        textarea.bulk-input { width: 100%; height: 200px; padding: 15px; border: 1px solid var(--border); border-radius: 8px; margin: 15px 0; font-family: monospace; font-size: 13px; }

        /* SETTINGS BAR (Toggle Columns) */
        .settings-bar { padding: 10px 20px; background: #f1f5f9; border-bottom: 1px solid var(--border); display: flex; gap: 15px; font-size: 12px; }
        .toggle-label { display: flex; align-items: center; gap: 5px; cursor: pointer; user-select: none; }

        @media print {
            .no-print { display: none !important; }
            body { padding: 0; background: white; }
            .card { border: none; box-shadow: none; }
            .table-wrapper { max-height: none; }
            td input { border: none; background: transparent; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section no-print">
        <div class="brand">
            <h1>SiPandu Nilai</h1>
            <p>Rekapitulasi Nilai & Asesmen ‚Ä¢ V.2.0</p>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-outline" onclick="downloadExcel()">üìä Download Excel</button>
            <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Cetak / PDF</button>
        </div>
    </div>

    <div class="card">
        <div class="controls no-print">
            <div class="control-group">
                <div>
                    <label>Mata Pelajaran</label><br>
                    <input type="text" id="mapel" placeholder="Contoh: Matematika" oninput="saveData()" style="width:150px;">
                </div>
                <div>
                    <label>Kelas</label><br>
                    <input type="text" id="kelas" placeholder="IV-A" oninput="saveData()" style="width:80px;">
                </div>
            </div>

            <div class="control-group">
                <button class="btn btn-success" onclick="openModal()">+ Input Siswa (Massal)</button>
                <button class="btn btn-outline" onclick="addColumn()">+ Kolom Nilai</button>
                <button class="btn btn-danger" onclick="resetData()">Reset Semua</button>
            </div>
        </div>

        <div class="settings-bar no-print">
            <span style="font-weight:bold; color:var(--text-light);">TAMPILKAN KOLOM:</span>
            <label class="toggle-label"><input type="checkbox" id="togSikap" onchange="renderTable()" checked> Sikap</label>
            <label class="toggle-label"><input type="checkbox" id="togDesc" onchange="renderTable()" checked> Deskripsi/Catatan</label>
            <label class="toggle-label"><input type="checkbox" id="togRank" onchange="renderTable()"> Perangkingan (Opsional)</label>
        </div>

        <div class="table-wrapper">
            <table id="gradeTable">
                <thead>
                    <tr id="tableHead">
                        </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>
    </div>
    
    <div class="no-print" style="text-align:center; color:var(--text-light); font-size:12px; margin-top:20px;">
        Tips: Gunakan tombol <b>TAB</b> di keyboard untuk pindah antar kolom nilai dengan cepat. Data tersimpan otomatis.
    </div>
</div>

<div id="studentModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0">Input Siswa Massal</h3>
        <p style="font-size:13px; color:var(--text-light);">Copy nama siswa dari Excel/Word, lalu Paste di bawah ini. Satu baris = satu siswa.</p>
        <textarea id="bulkText" class="bulk-input" placeholder="Ahmad&#10;Budi&#10;Citra&#10;..."></textarea>
        <div style="text-align:right; gap:10px; display:flex; justify-content:flex-end;">
            <button class="btn btn-outline" onclick="closeModal()">Batal</button>
            <button class="btn btn-primary" onclick="processBulk()">Proses Data</button>
        </div>
    </div>
</div>

<script>
    // DATA STRUCTURE
    // Kita pakai struktur yang fleksibel
    let db = JSON.parse(localStorage.getItem('sipandu_nilai_v2')) || {
        meta: { mapel: '', kelas: '' },
        columns: ['TP 1', 'TP 2', 'STS', 'SAS'], // Default columns
        students: [] // Array of { name: 'Ahmad', scores: { 'TP 1': 80 }, sikap: '', desc: '' }
    };

    window.onload = () => {
        document.getElementById('mapel').value = db.meta.mapel;
        document.getElementById('kelas').value = db.meta.kelas;
        renderTable();
    };

    function saveData() {
        db.meta.mapel = document.getElementById('mapel').value;
        db.meta.kelas = document.getElementById('kelas').value;
        localStorage.setItem('sipandu_nilai_v2', JSON.stringify(db));
    }

    // --- RENDERING ENGINE ---
    function renderTable() {
        const thead = document.getElementById('tableHead');
        const tbody = document.getElementById('tableBody');
        const showSikap = document.getElementById('togSikap').checked;
        const showDesc = document.getElementById('togDesc').checked;
        const showRank = document.getElementById('togRank').checked;

        // 1. Render Headers
        let hHtml = `<th style="width:40px">No</th><th style="min-width:200px">Nama Siswa</th>`;
        
        // Dynamic Grade Columns
        db.columns.forEach((col, idx) => {
            hHtml += `<th style="min-width:80px">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span contenteditable="true" onblur="renameColumn(${idx}, this.innerText)">${col}</span>
                    <span class="no-print" onclick="removeColumn(${idx})" style="cursor:pointer; color:#ef4444; margin-left:5px;">√ó</span>
                </div>
            </th>`;
        });

        // Fixed Columns
        hHtml += `<th style="width:80px; background:#f0fdf4;">Rata-rata</th>`;
        if (showSikap) hHtml += `<th style="min-width:100px">Sikap</th>`;
        if (showDesc) hHtml += `<th style="min-width:200px">Catatan</th>`;
        if (showRank) hHtml += `<th style="width:60px">Rank</th>`;
        hHtml += `<th class="no-print" style="width:40px"></th>`; // Delete btn

        thead.innerHTML = hHtml;

        // 2. Render Body
        let bHtml = '';
        
        // Calculate ranks if needed
        let sortedIndices = [];
        if(showRank) {
            const scores = db.students.map((s, i) => ({ idx: i, avg: calculateAvg(s.scores) }));
            scores.sort((a, b) => b.avg - a.avg);
            sortedIndices = scores.map(x => x.idx);
        }

        db.students.forEach((s, i) => {
            let rowHtml = `<tr>`;
            rowHtml += `<td style="text-align:center; background:#f8fafc;">${i+1}</td>`;
            rowHtml += `<td><input type="text" value="${s.name}" onchange="updateStudent(${i}, 'name', this.value)" style="font-weight:600;"></td>`;

            // Grade Inputs
            db.columns.forEach(col => {
                const val = s.scores[col] || '';
                rowHtml += `<td><input type="number" value="${val}" onchange="updateScore(${i}, '${col}', this.value)" placeholder="-"></td>`;
            });

            // Average (Auto Calc)
            const avg = calculateAvg(s.scores);
            const avgDisplay = avg > 0 ? avg : '-';
            rowHtml += `<td class="col-avg">${avgDisplay}</td>`;

            // Optional Columns
            if (showSikap) {
                rowHtml += `<td>
                    <select onchange="updateStudent(${i}, 'sikap', this.value)" style="border:none; width:100%; background:transparent;">
                        <option value="">-</option>
                        <option value="SB" ${s.sikap=='SB'?'selected':''}>SB</option>
                        <option value="B" ${s.sikap=='B'?'selected':''}>B</option>
                        <option value="C" ${s.sikap=='C'?'selected':''}>C</option>
                        <option value="K" ${s.sikap=='K'?'selected':''}>K</option>
                    </select>
                </td>`;
            }
            if (showDesc) {
                rowHtml += `<td><input type="text" value="${s.desc||''}" onchange="updateStudent(${i}, 'desc', this.value)" placeholder="Catatan..."></td>`;
            }
            if (showRank) {
                const rank = sortedIndices.indexOf(i) + 1;
                rowHtml += `<td style="text-align:center; font-weight:bold;">#${rank}</td>`;
            }

            // Delete Action
            rowHtml += `<td class="no-print" style="text-align:center;">
                <button onclick="deleteStudent(${i})" style="background:none; border:none; color:#ef4444; cursor:pointer; font-weight:bold;">√ó</button>
            </td>`;

            rowHtml += `</tr>`;
            bHtml += rowHtml;
        });

        tbody.innerHTML = bHtml;
    }

    // --- LOGIC ---
    function calculateAvg(scoresObj) {
        let sum = 0;
        let count = 0;
        db.columns.forEach(col => {
            const val = parseFloat(scoresObj[col]);
            if (!isNaN(val)) {
                sum += val;
                count++;
            }
        });
        return count === 0 ? 0 : Math.round(sum / count);
    }

    function updateScore(idx, col, val) {
        db.students[idx].scores[col] = val;
        saveData();
        renderTable(); // Re-render to update average & rank
    }

    function updateStudent(idx, field, val) {
        db.students[idx][field] = val;
        saveData();
    }

    function addColumn() {
        const name = prompt("Nama Kolom Nilai (misal: PH 3, Tugas, Praktik):");
        if (name && !db.columns.includes(name)) {
            db.columns.push(name);
            saveData();
            renderTable();
        }
    }

    function renameColumn(idx, newVal) {
        const oldName = db.columns[idx];
        if (newVal && newVal !== oldName) {
            db.columns[idx] = newVal;
            // Migrate data
            db.students.forEach(s => {
                s.scores[newVal] = s.scores[oldName];
                delete s.scores[oldName];
            });
            saveData();
        }
    }

    function removeColumn(idx) {
        if (confirm(`Hapus kolom ${db.columns[idx]} beserta isinya?`)) {
            const colName = db.columns[idx];
            db.columns.splice(idx, 1);
            db.students.forEach(s => delete s.scores[colName]);
            saveData();
            renderTable();
        }
    }

    function deleteStudent(idx) {
        if (confirm("Hapus siswa ini?")) {
            db.students.splice(idx, 1);
            saveData();
            renderTable();
        }
    }

    function resetData() {
        if (confirm("Yakin ingin menghapus SEMUA data?")) {
            db.students = [];
            db.columns = ['TP 1', 'TP 2', 'STS', 'SAS'];
            saveData();
            renderTable();
        }
    }

    // --- MASS INPUT HANDLER ---
    function openModal() { document.getElementById('studentModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('studentModal').style.display = 'none'; }
    
    function processBulk() {
        const text = document.getElementById('bulkText').value;
        const lines = text.split('\n');
        let count = 0;
        lines.forEach(line => {
            const name = line.trim();
            if (name) {
                db.students.push({
                    name: name,
                    scores: {},
                    sikap: '',
                    desc: ''
                });
                count++;
            }
        });
        document.getElementById('bulkText').value = '';
        closeModal();
        saveData();
        renderTable();
        alert(`Berhasil menambahkan ${count} siswa.`);
    }

    // --- EXPORT TO EXCEL ---
    function downloadExcel() {
        // Prepare Data for SheetJS
        const data = [];
        
        // Header Row
        const header = ["No", "Nama Siswa", ...db.columns, "Rata-rata", "Sikap", "Catatan"];
        data.push(header);

        // Rows
        db.students.forEach((s, i) => {
            const row = [i + 1, s.name];
            db.columns.forEach(col => row.push(s.scores[col] || ''));
            row.push(calculateAvg(s.scores));
            row.push(s.sikap || '');
            row.push(s.desc || '');
            data.push(row);
        });

        // Create Workbook
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Nilai");
        XLSX.writeFile(wb, `Nilai_${db.meta.mapel || 'Mapel'}.xlsx`);
    }
</script>

</body>
</html>
